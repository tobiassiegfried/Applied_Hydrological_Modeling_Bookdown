# (APPENDIX) Appendix {#ChapterAppendix}

## Appendix A: Open-source Software

### QGIS
QGIS is a free and open source Geographical Information System that offers very similar tools as their commercial counterparts. The latest version of QGIS can be downloaded from the [QGIS website](https://qgis.org/en/site/). We recommend to install the stable long-term support version.  

#### Resources for learning QGIS 
A general tutorial for beginners is the  [QGIS training manual](https://docs.qgis.org/3.16/en/docs/training_manual/index.html). It includes a short chapter on the use of QGIS for hydrological analysis (Chapter 17.16). For this course you should be familiar with the QGIS window and know the difference between raster and vector data. If you have used QGIS or a similar GIS software before you will not need to do a tutorial prior to this course.  


### R and RStudio
R is a free and open source statistical programming language. It's large user community ensure active development and up-to-date help resources available on the internet. RStudio is a free user interface for R. To install R and RStudio follow the installation guide on [ModernDive - Statistical Inference via Data Science](https://moderndive.com/index.html)

#### Resources for learning R and R studio 
* “Help! I’m new to R and RStudio and I need to learn them! What do I do?” If you’re asking yourself this, this book is for you: [ModernDive - Statistical Inference via Data Science](https://moderndive.com/index.html). 
* A thorough guide for data science in R: [R for Data Science](https://r4ds.had.co.nz/index.html)   

### RS Minerve
#### How to download and install RS Minerve {#section-quickguides-how-to-download-and-install-rsminerve}
Go to the software download page of CREALP's website  [https://www.crealp.ch/fr/accueil/outils-services/logiciels/rs-minerve/telechargement-rsm.html](https://www.crealp.ch/fr/accueil/outils-services/logiciels/rs-minerve/telechargement-rsm.html) (last accessed March 18, 2021) and click on *Version actuelle* to download the latest installer for Windows (see Figure \@ref(fig:fig-download-rsminerve)). This will start the download process for the installer RSMinerve-install.exe. 

```{r fig-download-rsminerve, echo=FALSE, out.width="95%", fig.align="center", fig.cap="Download RS Minerve from the CREALP website [https://www.crealp.ch/fr/accueil/outils-services/logiciels/rs-minerve/telechargement-rsm.html](https://www.crealp.ch/fr/accueil/outils-services/logiciels/rs-minerve/telechargement-rsm.html) (last accessed March 18, 2021)."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig_downloadSiteRSMinerve.png")
```

You should also download the user manual (*RS MINERVE user manual*, written in English) and the example files used for the tutorials in the user manual (*Exemple de fichiers*, a zip file with data) as well as the technical manual (*RS MINERVE technical manual*, written in English).   
Once the installer is downloaded, install RS Minerve with a double-click on the installer and follow the Setup guide. Open RS Minerve once you have it installed. 

[Back to the prerequisites for RS Minerve modelling](#section-rsminerve-prerequisites)



## Appendix B: Quick Guides

### QGIS

### RS Minerve









## Appendix C: Processing Climate Data

### Cutting CHELSA v.1.2.1 to CA Domain

The CHELSA v1.2.1 data is a global dataset. The data can be cut to the Central Asia domain in the following way.

```{r,eval=FALSE}
dir_CHELSA <- '/Users/tobiassiegfried/Dropbox (hydrosolutions)/1_HSOL_PROJECTS/PROJECTS/SDC/DKU_WRM_COURSE_CA/CourseMaterials/Data/CLIMATE/CHELSA_V1_2_1/'

# First, we process precipitation data (prec).
prec_CHELSA_files <- list.files(paste0(dir_CHELSA,'tp/'))
for (idx in 1:length(prec_CHELSA_files)){
  str2Print <- paste0('Processing PREC: ', idx, ' out of ', length(prec_CHELSA_files) )
  print(str2Print)
  fName <- prec_CHELSA_files[idx]
  global_CHELSA_raster <- raster(paste0(dir_CHELSA,'prec/',fName))
  centralAsia_CHELSA_raster <- raster::crop(global_CHELSA_raster,aoi_CentralAsia_LatLon)
  # Save the centralAsia_CHELSA_raster
  fName2Save <- paste0(substr(fName,1,19),'_CA',substr(fName,20,30))
  raster::writeRaster(centralAsia_CHELSA_raster,
                      paste0(dir_CHELSA,'prec/',fName2Save),
                      'GTiff',
                      overwrite = TRUE)
}

# Second, we process mean temperature data (tmean).
tmean_CHELSA_files <- list.files(paste0(dir_CHELSA,'t2m/'))
for (idx in 1:length(tmean_CHELSA_files)){
  str2Print <- paste0('Processing TMEAN: ', idx, ' out of ', length(tmean_CHELSA_files) )
  print(str2Print)
  fName <- tmean_CHELSA_files[idx]
  global_CHELSA_raster <- raster(paste0(dir_CHELSA,'tmean/',fName))
  centralAsia_CHELSA_raster <- raster::crop(global_CHELSA_raster,aoi_CentralAsia_LatLon)
  # Save the centralAsia_CHELSA_raster
  fName2Save <- paste0(substr(fName,1,20),'_CA',substr(fName,21,35))
  raster::writeRaster(centralAsia_CHELSA_raster,
                      paste0(dir_CHELSA,'tmean/',fName2Save),
                      'GTiff',
                      overwrite = TRUE)
}

(raster(paste0(dir_CHELSA,'tmean/',fName2Save))/10 - 273.15) %>% plot()
```

### Bias Correcting CHELSA v1.2.1 Precipitation Data for Snow Undercatch

```{r,eval=FALSE}
## general info - function arguments
basinName <- 'Gunt'
dataType_ERA5 <- 'tp'
#basinShape <- 'to be passed in'
targetCRS <- "+init=epsg:32642"
## Directories of relevant climate files  - function arguments
dir_CHELSA <- '/Users/tobiassiegfried/Dropbox (hydrosolutions)/1_HSOL_PROJECTS/PROJECTS/SDC/DKU_WRM_COURSE_CA/CourseMaterials/Data/CLIMATE/CHELSA_V1_2_1/'
# Basin AOI - function arguments, but check if all can be derived from the basinShape that is anyhow to be passed in!
aoi_Basin_LatLon <- gunt_Shapefile_LatLon %>% extent # GUNT
# ===
fileCorrFact <- '/Users/tobiassiegfried/Dropbox (hydrosolutions)/1_HSOL_PROJECTS/PROJECTS/SDC/DKU_WRM_COURSE_CA/CourseMaterials/Data/CLIMATE/PBCOR_V1/CHELSA_V12.nc'
# Get CHELSA file list - Note, we already have cut to the CA domain!
fileList <- list.files(paste0(dir_CHELSA,dataType_ERA5))
# beginning and end
startY <- 1981
endY <- 2013
# Monthly correction factors (Beck et al., 2020)
#pbcorr_monthly <- nc_open(dir_CorrFact)
pbcorr_monthly <- brick(fileCorrFact, varname="corr_fac_monthly")
pbcorr_monthly_basin_longlat <- raster::crop(pbcorr_monthly,aoi_CentralAsia_LatLon)
# start to loop through years and months for bias correcting the monthly values.
for (yr in startY:endY){
  for (mon in 1:12){
    # Load corresponding tmean CHELSA Central Asia File
    if (mon<10){
      chelsa_data_orig <- 
        raster(paste0(dir_CHELSA,dataType_ERA5,'/CHELSA_prec_',yr,'_0',mon,'_CA_V1.2.1.tif'))
      numbPrefix <- '_0'
    } else {
      chelsa_data_orig <- 
        raster(paste0(dir_CHELSA,dataType_ERA5,'/CHELSA_prec_',yr,'_',mon,'_CA_V1.2.1.tif'))
      numbPrefix <- '_'
    }
    chelsa_data_orig_resamp <- raster::resample(chelsa_data_orig,pbcorr_monthly_basin_longlat)
    chelsa_data_bcorr_resamp <- overlay(chelsa_data_orig_resamp,subset(pbcorr_monthly_basin_longlat,mon),
                                        fun=function(x,y){return(x*y)})
   # write bias corrected CHELSA back to the disk.
    raster::writeRaster(chelsa_data_bcorr_resamp,
                        paste0(dir_CHELSA,dataType_ERA5,'/CHELSA_tp_bcorr_',yr,numbPrefix,mon,'_CA_V1.2.1.tif'),
                        'GTiff',
                        varname   = dataType_ERA5,
                        overwrite = TRUE)
    #chelsa_data_bcorr_resamp %>% plot()
  }
}
```

### Computing Mean Monthly Temperature Climatology from CHELSA v1.2.1 data

The following code take CHELSA_V1.2.1 mean monthly temperature raster data and computes long-term mean monthly temperatures over the Central Asia domain. The resulting file can optionally be stored on the disk.

```{r, eval=FALSE}
fDir <- '../HydrologicalModeling_CentralAsia_Data/CentralAsiaDomain/CHELSA_V1.2.1/'
# First, we process and display mean monthly 2 meters temperatures.
varDir <- 't2m/'
t2m_files <- list.files(paste0(fDir,varDir))
# Get monthly fields and average over all data for resulting climatology
idxSeq <- seq(1,409,12)
for (idx in (1:12)){
  print(months[idx])
  t2m_files_sel <- t2m_files[idxSeq]
  for (idxRaster in (1:length(t2m_files_sel))){
    if (idxRaster == 1){
      raster_res <- raster::raster(paste0(fDir,varDir,'/',t2m_files_sel[1]))
    } else {
      raster_n <- raster::raster(paste0(fDir,varDir,'/',t2m_files_sel[idxRaster]))
      raster_res <- raster::addLayer(raster_n,raster_res)
    }
    raster_res_mean <- calc(raster_res, fun = mean)
  }
  if (idx ==1){
    raster_res_mean_stack <- raster_res_mean
  } else {
    raster_res_mean_stack <- raster::addLayer(raster_res_mean_stack,raster_res_mean)
  }
  idxSeq  <- idxSeq + 1
}

names(raster_res_mean_stack) <- month.abb

# raster::writeRaster(raster_res_mean_stack,
#                         paste0(fDir,'t2m_climatology/t2m_climatology_CA.tiff'),
#                         options="INTERLEAVE=BAND",
#                         'GTiff',
#                         varname   = 't2m',
#                         overwrite = TRUE)
```

### ERA5




## Appendix D: Solutions to exercises {#sectin-appendix-solutions}

### Exercise on Linear Reservoir modelling {#section-appendix-solutions-exercise1}
#### Task 1 {#solution-task1-experimental-setup}  

##### What will determine the flow through your bucket?  
The flow through the bucket will be influenced by the volume to bottom area fraction of the bucket, the amount and speed of water added to the bucket and the size of the outlet hole. 

##### What do you need to measure?   
You will need to measure:   

* the discharge from your bucket over time,  
* the recharge volume (how much water you put into the bucket over a given time),   
* the time when you start pouring water and when you stop pouring water into the bucket,  
* the approximate volume of your bucket.  

##### How can you measure it? 
This depends on what you have available. You can draw a water level line outside of your outflow receptacle every 10 seconds and then determine the volume change over time. Maybe you have a scale and a smart phone so you can put your outflow receptacle on the scale and make a movie of the weight change over time (1kg of water is approximately 1l of water).   
For the inflow pour a well defined volume over a well defined time interval. You can do this manually unless of course you have pipes and valves lying around that you can use.   
You will need a watch for measuring time and a receptacle with known volume to measure volumes (or a scale).    
A couple of notes on measurement accuracy:   

* Generally, the larger the volumes, the smaller the relative measurement error. Say you measure a discharge of 50ml in 1s (i.e. 50ml/s) and you can read your volume with an accuracy of 5ml and the time with an accuracy of 0.2s. Your measurement uncertainty becomes 11ml/s which is more than 20% of your discharge. If on the other hand, you measure 500ml over 10s (which is the same discharge of 50ml/s) with the same inaccuracies for volume and time your measurement uncertainty for discharge becomes 1ml/s which is only 2% of your discharge.  
* How do you estimate measurement uncertainties: Measure several times, compute the average and the standard deviation of your measurements assuming a student-t distribution.   
* How do you combine uncertainties of volume and time to the uncertainty of discharge: By applying Gaussian error propagation.   

##### What materials you will need to set up the experiment?
* For the bucket (the linear reservoir): A plastic bottle, a box or a can that is no longer used. It should have an opening at the top and the material should repel water and be thin enough that you can drill a hole into the wall.   
* A pair of pointy scissors or a knife to drill a hole into the bucket.   
* A water source (a tap, hose or a water container larger than the one above). This will be your rain machine.   
* A watch to measure time.  
* Note paper and pen.   
* A receptacle for measuring the outflow.   
* Additional material to facilitate measurement according to availability.   

```{r fig-solution1-example-setup, echo=FALSE, fig.show = "hold", out.width="90%", fig.align="center", fig.cap="Example for material needed and example setup to perform the linear reservoir experiment. Add a minion with a stop watch or a smart phone to help you logging the discharge from the bucket. "}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig_experimentalSetup.jpg")
```

##### Where will you get the water from and can you re-use it after the experiment? 
This depends on your situation.   

Back to the [recap section](#section-rsminerve-why-model-introduction)


#### Task 2 {#solution-task2-perform-experiment}
The video was recorded with a smart phone. The weight of the outflow receptacle was noted down every second. The discharge is computed as the change of volume in the outflow receptacle over time.    

<iframe width="720" height="480" src="_bookdown_files/FIG_Appendix_QuickGuides/bucket_video.mp4" align="middle" frameborder="0" allowfullscreen></iframe>

Back to the [recap section](#section-rsminerve-why-model-introduction)


#### Task 3 {#solution-task3-simulate}
The height of the measured discharge peak can be best reproduced with k = 0.42. However, the measured discharge peaks 1s later than the simulated discharge peak.   
Reasons for the discrepancy can be the shape of the linear reservoir, non-linear pouring speed, and measurement uncertainties.       

Back to the [recap section](#section-rsminerve-why-model-introduction)


# (APPENDIX) Appendix {#ChapterAppendix}

## Appendix A: Open-source resources

### Literature
Many authors of scientific literature are on the web platform [researchgate](https://www.researchgate.net/) where they can privately share their work with students (users need to register for an account).

### QGIS
QGIS is a free and open source Geographical Information System that offers very similar tools as their commercial counterparts. The latest version of QGIS can be downloaded from the [QGIS website](https://qgis.org/en/site/). We recommend to install the stable long-term support version.  

#### Resources for learning QGIS 
A general tutorial for beginners is the  [QGIS training manual](https://docs.qgis.org/3.16/en/docs/training_manual/index.html). It includes a short chapter on the use of QGIS for hydrological analysis (Chapter 17.16). For this course you should be familiar with the QGIS window and know the difference between raster and vector data. If you have used QGIS or a similar GIS software before you will not need to do a tutorial prior to this course.  


### R and RStudio
R is a free and open source statistical programming language. It's large user community ensure active development and up-to-date help resources available on the internet. RStudio is a free user interface for R. To install R and RStudio follow the installation guide on [ModernDive - Statistical Inference via Data Science](https://moderndive.com/index.html)

#### Resources for learning R and R studio 
* “Help! I’m new to R and RStudio and I need to learn them! What do I do?” If you’re asking yourself this, this book is for you: [ModernDive - Statistical Inference via Data Science](https://moderndive.com/index.html). 
* A thorough guide for data science in R: [R for Data Science](https://r4ds.had.co.nz/index.html)   

### RS Minerve
#### How to download and install RS Minerve {#section-quickguides-how-to-download-and-install-rsminerve}
Go to the software download page of CREALP's website  [https://www.crealp.ch/fr/accueil/outils-services/logiciels/rs-minerve/telechargement-rsm.html](https://www.crealp.ch/fr/accueil/outils-services/logiciels/rs-minerve/telechargement-rsm.html) (last accessed March 18, 2021) and click on *Version actuelle* to download the latest installer for Windows (see Figure \@ref(fig:fig-download-rsminerve)). This will start the download process for the installer RSMinerve-install.exe. 

```{r fig-download-rsminerve, echo=FALSE, out.width="95%", fig.align="center", fig.cap="Download RS Minerve from the CREALP website [https://www.crealp.ch/fr/accueil/outils-services/logiciels/rs-minerve/telechargement-rsm.html](https://www.crealp.ch/fr/accueil/outils-services/logiciels/rs-minerve/telechargement-rsm.html) (last accessed March 18, 2021)."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig_downloadSiteRSMinerve.png")
```

You should also download the user manual (*RS MINERVE user manual*, written in English) and the example files used for the tutorials in the user manual (*Exemple de fichiers*, a zip file with data) as well as the technical manual (*RS MINERVE technical manual*, written in English).   
Once the installer is downloaded, install RS Minerve with a double-click on the installer and follow the Setup guide. Open RS Minerve once you have it installed. 

[Back to the prerequisites for RS Minerve modelling](#section-rsminerve-prerequisites)





## Appendix B: Quick Guides

### QGIS: 

### RSM: Create HBV model and edit parameters {#section-quickguides-create-hbv-model}  
Click on the HBV model icon in the model selection panel (Figure \@ref(fig:fig-create-hbv-model)). 
```{r fig-create-hbv-model, echo=FALSE, out.width="50%", fig.align="center", fig.cap="To generate an HBV model, click on the HBV model icon in the model selection panel."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig100_HBVinModelSelectionPanel.png")
```

Move your cursor to the white area in the center and create a HBV model with a click. The HBV model icon will now appear in the white model panel (Figure \@ref(fig:fig-hbv-model-generated)). 
```{r fig-hbv-model-generated, echo=FALSE, out.width="95%", fig.align="center", fig.cap="A HBV model has been generated."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig101_HBVmodelGenerated.png")
```

Edit the parameters of the model by double-clicking on the model icon and changing parameter values in the table that appears to the right of the RS Minerve window (Figure \@ref(fig:fig-edit-hbv-model-single)). 
```{r fig-edit-hbv-model-single, echo=FALSE, out.width="95%", fig.align="center", fig.cap="Double-click on the HBV model to open and edit the parameter table. "}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig102_editParametersSingleModel.png")
```

Alternatively (especially if you have to change parameters for several models), activate the Parameters panel in the Model Properties toolbar (Figure \@ref(fig:fig-activate-parameters-panel)). 
```{r fig-activate-parameters-panel, echo=FALSE, out.width="95%", fig.align="center", fig.cap="Activate the Parameters panel in the Model Properties toolbar. "}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig103_activateParametersPanel.png")
```

Select the HBV model in the Parameters panel (Figure \@ref(fig:fig-select-hbv-parameters-panel)). 
```{r fig-select-hbv-parameters-panel, echo=FALSE, out.width="95%", fig.align="center", fig.cap="Select HBV in the Parameters panel."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig104_selectHBVparameters.png")
```

If you have several HBV models, you can select models by zone and apply edits in the parameter table in the left of the Parameters panel to all selected models (mark with tick). You can also edit paramers for individual models in the right-hand table of the Parameters panel (Figure \@ref(fig:fig-edit-hbv-parameters-panel)). 
```{r fig-edit-hbv-parameters-panel, echo=FALSE, out.width="95%", fig.align="center", fig.cap="Edit parameters for groups of models (left parameter table) or for individual models (right parameter table)."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig105_editParametersInParametersPanel.png")
```

Save your model by clicking the floppy disk icon in the toolbar.   

You can also export parameters to a text file via the button *Export P* in the Model Properties toolbar, edit the text file and import the edited parameter file through *Import P*.   

The area of the HBV model should be 99'000'000 m2.   

Back to the [Nauvalisoy model guide](#section-hbv-nauvalisoy-modelling-setup). 


### RSM: Add and link climate station {#section-quickguides-add-climate-station)}
Move your cursor to the V-Station icon in the models panel (the first icon in Figure \@ref(fig:fig-create-hbv-model)). Click on the icon to activate it and click next to the HBV model in your model pane to place the V-Station. With a double-click on the newly created V-Station, you can visualize the parameters of the virtual weather station.   
Connect the station to the HBV model by activating the Connections mode in the Editing tools toolbar (Figure \@ref(fig:fig-connect-V-station1)). 
```{r fig-connect-V-station1, echo=FALSE, out.width="95%", fig.align="center", fig.cap="Create a virtual weather station."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig108_createVStation.png")
```

Click on the station, hold down the finger move your cursor to the HBV model, then release the hold. A grey line appeart between the station and the model and a pop-up window asks you to verify the data links between the two components (Figure \@ref(fig:fig-connect-V-station2)). 
```{r fig-connect-V-station2, echo=FALSE, out.width="95%", fig.align="center", fig.cap="Link the virtual weather station to the HBV model."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig109_linkVStation.png")
```
Click Ok to accept the suggested data links and a blue arrow will appear between the weather station and the model. Click on the black arrow in the Editing tools toolbar to leave the Connections model.     

Back to the [Nauvalisoy model guide](#section-hbv-nauvalisoy-modelling-setup). 


### RSM: Import climate data {#section-quickguides-import-climate-data}
Go to the database tab and click on Open in the File database toolbar (Figure \@ref(fig:fig-open-database-tab)).  
```{r fig-open-database-tab, echo=FALSE, out.width="95%", fig.align="center", fig.cap="The database tab."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig110_databasetab.png")
```

Select the file./data/SyrDarya/Chirchiq/RSMinerve/ERA5_Nauvalisoy_1981_2013.csv. If you don't see the file in your file browser, make sure the file ending .csv is selected in the file browser (Figure \@ref(fig:fig-open-database-tab-csv)).

```{r fig-open-database-tab-csv, echo=FALSE, out.width="60%", fig.align="center", fig.cap="Make sure the file ending is .csv in the file browser."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig111_dbfileEnding.png")
```

Press open to load the data into RSMinerve. Depending on your computer this may take a few seconds. Once the data is loaded, click through the database browser in the left pane to explore the data (Figure \@ref(fig:fig-explore-db)).
```{r fig-explore-db, echo=FALSE, out.width="60%", fig.align="center", fig.cap="Explore the data base."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig112_exploreDataDB.png")
```

To connect the data base to the model you will need to make the data consistent with the model. To do this change the name "New group" to "Measurements" and select Input for the category (Figure \@ref(fig:fig-db-measurements)). 
```{r fig-db-measurements, echo=FALSE, out.width="60%", fig.align="center", fig.cap="Change \"New group\" to \"Measurements\" and select Input as category."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig113_changenewdata.png")
```

Browse the name of the station (Figure \@ref(fig:fig-station-name-db)). 
```{r fig-station-name-db, echo=FALSE, out.width="60%", fig.align="center", fig.cap="The name of the station is \"Nauvalisoy\"."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig114_stationName.png")
```

As our weather data is representative for the entire Nauvalisoy catchment, the station name in the data base needs to be consistent with the station name of the V-Station in the model pane. Change the name of the station in the model pane from V-Station to Nauvalisoy by clicking on the name.   

Choose the nauvalisoy data set as source and adapt the simulation period as shown in Figure \@ref(fig:fig-validate-model). 
```{r fig-validate-model, echo=FALSE, out.width="60%", fig.align="center", fig.cap="Choose the nauvalisoy data set to link the weather station data to the virtual weather station. The simulation times should not extend the period of the input data. Simulation time step is 1 hour and the recording time step is 1 month."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig115_solverspecs.png")
```

Click on *Validation* to verify that the model has been set up correctly. Once you have adapted the model settings to calculate evaporation based on temperature ([how to](#section-quickguides-atapt-model-settings)), no errors should be reported. You can now run the model. A warning tells you that the number of meteo stations is not sufficient. Ignore the warning for now. 

[Nauvalisoy model guide](#section-hbv-nauvalisoy-modelling-setup)


### RSM: Adapt model settings {#section-quickguides-atapt-model-settings}
Navigate to Edit in the Settings toolbar (Figure \@ref(fig:fig-open-settings-tab)). 
```{r fig-open-settings-tab, echo=FALSE, out.width="95%", fig.align="center", fig.cap="Open the models settings tab."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig106_openSettingsTab.png")
```

Open the Settings tab and choose an ET model. Adapt the coordinates of the project (choose the station coordinates mentioned in the introduction section) (Figure \@ref(fig:fig-change-settings)). 
```{r fig-change-settings, echo=FALSE, out.width="95%", fig.align="center", fig.cap="Edit the evaporation calculation method and the coordinates of the project."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig107_changeSettings.png")
```
   
Back to the [model guide](#section-modelling-setup)


### RSM: Export simulation results to data base {#section-export-sim-results-to-db}
Go to Export in the Database toolbar (Figure \@ref(fig:fig-export-to-db)). Define a name for the simulation results and choose a data base group to save the data to. Create a new group if you haven't already done so. 

```{r fig-export-to-db, echo=FALSE, out.width="95%", fig.align="center", fig.cap="Export simulation results to the data base."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig117_exportResultsToDB.png")
```

The data sets are now available in the data base tab and can be visualized in the Selection and plots tab.  

Back to the [model guide](#section-modelling-setup)


### RSM: Add comparator and load discharge measurements {#section-quickguides-add-comparator-and-discharge-data}
The comparator object allows the user to compare a simulated variable to a reference. In our case, we want to compare the simulated discharge of the Nauvalisoy river to the measured one. The measured discharge can be imported to RS Minerve via the database tab.  
Move your cursor to the comparator icon (Figure \@ref(fig:rsminerve-comparator-icon)) in the model components panel. 
```{r rsminerve-comparator-icon, echo=FALSE, out.width="10%", fig.align="center", fig.cap="Comparator icon in RS Minerve."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig_comparator_icon.png")
```

Activate it with a right-click and move your cursor next to the HBV model in the model pane. Place the comparator object with another click. 

Add a source object to your model following the same procedure as for the comparator object. Figure \@ref(fig:rsminerve-source-icon) shows the icon of the source object.  
```{r rsminerve-source-icon, echo=FALSE, out.width="10%", fig.align="center", fig.cap="Comparator icon in RS Minerve."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig_source_icon.png")
```

You can now optionally rename your model objects.   

Connect the source and the HBV model to the comparator by activating the Connections mode in the Editing Tools toolbar. Right-click on the HBV model, hold the click and drag the cursor to the comparator object where you release the cursor. You will be asked in a pop-up window to specify the flow your wish to compare and if it is to be viewed as a simulation result or the reference. Connect the total discharge computed by the HBV model component as simulation result to the comparator (Figure \@ref(fig:rsminerve-connect-hbv-comparator)) and close the pop-up window by pressing OK. 
```{r rsminerve-connect-hbv-comparator, echo=FALSE, out.width="60%", fig.align="center", fig.cap="Comparator icon in RS Minerve."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig_connectHBVtoComparator.png")
```

Connect the source object to the comparator in the same way as the HBV object. The source will be connected as reference (Figure \@ref(fig:rsminerve-connect-source-comparator)).

```{r rsminerve-connect-source-comparator, echo=FALSE, out.width="60%", fig.align="center", fig.cap="Source icon in RS Minerve."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig_connectSourcetoComparator.png")
```

Next, we have to load the (synthetic) discharge data into the database. Navigate to the database tab. In the database, go to Measurements -> nauvalisoy and click *Add* and enter a name for the discharge station (Figure \@ref(fig:rsminerve-add-discharge-database)). For this example, we do not need to bother with the coordinates.  
```{r rsminerve-add-discharge-database, echo=FALSE, out.width="60%", fig.align="center", fig.cap="Connect the outflow of the HBV model as simulation result to the comparator."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig_database_add_discharge_station.png")
```

Under the new discharge station, add a sensor and rename it to the source object in your model (Figure \@ref(fig:rsminerve-add-discharge-sensor)). 
```{r rsminerve-add-discharge-sensor, echo=FALSE, out.width="60%", fig.align="center", fig.cap="Connect the discharge measurements (source) as reference to the comparator."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig_add_discharge_sensor.png")
```

Open the tab with the Values. Here we need to import the discharge data. You can do that by opening the discharge data in a spreadsheet (e.g. Excel) and copy-pasting the dates and discharge values into the Values table in RS Minerve ([Here is how to do this step-by-step](#section-quickguides-copy-paste-database-values). 

Now we need to link the discharge data in the database to the source object in the model. Navigate to the model and 

```{r rsminerve-link-discharge-data-to-model, echo=FALSE, out.width="80%", fig.align="center", fig.cap="Select the data source for the source object (under Data Source in the left window pane) and select the sensor for discharge data for the source (under Source, Series identifier in the right window pane)."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig_connect_source_database_to_object.png")
```

Validate the model to see if the model setup went correctly. Run the model if the validation did not throw an error. 


Back to the [practical model calibration and validation section](#secion-calibration-practical-steps)


### RSM: Copy-paste data to database {#section-quickguides-copy-paste-database-values}
Open the file ./data/SyrDarya/Chirchiq/RSMinerve/synthetic_discharge_Nauvalisoy_river_for_calibration_exercise.csv in a spreadsheet software, e.g. Excel, Numbers, Google Sheets or OpenOffice Calc and select the rows containing dates and values (Figure \@ref(fig:fig-copy-spreadsheet-data)). Press control C or perform a left-click and choose copy. 

```{r fig-copy-spreadsheet-data, echo=FALSE, out.width="40%", fig.align="center", fig.cap="Select the rows and columns containing the dates and data to be copied. Press control C to copy the selected cells."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig000_copy_data_spreadsheet.png")
```

Then navigate to the discharge sensor on the database tab in RS Minerve where you want to add the data to. Click in the small square to the left of the first row in the Values tab and enter control P. Alternatively perform a right-click in the small square and select Paste. The dates and values from the excel sheet will now appear in the table (Figure \@ref(fig:fig-paste-spreadsheet-data)). Save the database. 

```{r fig-paste-spreadsheet-data, echo=FALSE, out.width="40%", fig.align="center", fig.cap="Paste dates and values to the database table."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig000_paste_values_database.png")
```

Back to the [practical model calibration and validation section](#secion-calibration-practical-steps)




## Appendix C: Processing Climate Data

### Cutting CHELSA v.1.2.1 to CA Domain

The CHELSA v1.2.1 data is a global dataset. The data can be cut to the Central Asia domain in the following way.

```{r,eval=FALSE}
dir_CHELSA <- '/Users/tobiassiegfried/Dropbox (hydrosolutions)/1_HSOL_PROJECTS/PROJECTS/SDC/DKU_WRM_COURSE_CA/CourseMaterials/Data/CLIMATE/CHELSA_V1_2_1/'

# First, we process precipitation data (prec).
prec_CHELSA_files <- list.files(paste0(dir_CHELSA,'tp/'))
for (idx in 1:length(prec_CHELSA_files)){
  str2Print <- paste0('Processing PREC: ', idx, ' out of ', length(prec_CHELSA_files) )
  print(str2Print)
  fName <- prec_CHELSA_files[idx]
  global_CHELSA_raster <- raster(paste0(dir_CHELSA,'prec/',fName))
  centralAsia_CHELSA_raster <- raster::crop(global_CHELSA_raster,aoi_CentralAsia_LatLon)
  # Save the centralAsia_CHELSA_raster
  fName2Save <- paste0(substr(fName,1,19),'_CA',substr(fName,20,30))
  raster::writeRaster(centralAsia_CHELSA_raster,
                      paste0(dir_CHELSA,'prec/',fName2Save),
                      'GTiff',
                      overwrite = TRUE)
}

# Second, we process mean temperature data (tmean).
tmean_CHELSA_files <- list.files(paste0(dir_CHELSA,'t2m/'))
for (idx in 1:length(tmean_CHELSA_files)){
  str2Print <- paste0('Processing TMEAN: ', idx, ' out of ', length(tmean_CHELSA_files) )
  print(str2Print)
  fName <- tmean_CHELSA_files[idx]
  global_CHELSA_raster <- raster(paste0(dir_CHELSA,'tmean/',fName))
  centralAsia_CHELSA_raster <- raster::crop(global_CHELSA_raster,aoi_CentralAsia_LatLon)
  # Save the centralAsia_CHELSA_raster
  fName2Save <- paste0(substr(fName,1,20),'_CA',substr(fName,21,35))
  raster::writeRaster(centralAsia_CHELSA_raster,
                      paste0(dir_CHELSA,'tmean/',fName2Save),
                      'GTiff',
                      overwrite = TRUE)
}

(raster(paste0(dir_CHELSA,'tmean/',fName2Save))/10 - 273.15) %>% plot()
```

### Bias Correcting CHELSA v1.2.1 Precipitation Data for Snow Undercatch

```{r,eval=FALSE}
## general info - function arguments
basinName <- 'Gunt'
dataType_ERA5 <- 'tp'
#basinShape <- 'to be passed in'
targetCRS <- "+init=epsg:32642"
## Directories of relevant climate files  - function arguments
dir_CHELSA <- '/Users/tobiassiegfried/Dropbox (hydrosolutions)/1_HSOL_PROJECTS/PROJECTS/SDC/DKU_WRM_COURSE_CA/CourseMaterials/Data/CLIMATE/CHELSA_V1_2_1/'
# Basin AOI - function arguments, but check if all can be derived from the basinShape that is anyhow to be passed in!
aoi_Basin_LatLon <- gunt_Shapefile_LatLon %>% extent # GUNT
# ===
fileCorrFact <- '/Users/tobiassiegfried/Dropbox (hydrosolutions)/1_HSOL_PROJECTS/PROJECTS/SDC/DKU_WRM_COURSE_CA/CourseMaterials/Data/CLIMATE/PBCOR_V1/CHELSA_V12.nc'
# Get CHELSA file list - Note, we already have cut to the CA domain!
fileList <- list.files(paste0(dir_CHELSA,dataType_ERA5))
# beginning and end
startY <- 1981
endY <- 2013
# Monthly correction factors (Beck et al., 2020)
#pbcorr_monthly <- nc_open(dir_CorrFact)
pbcorr_monthly <- brick(fileCorrFact, varname="corr_fac_monthly")
pbcorr_monthly_basin_longlat <- raster::crop(pbcorr_monthly,aoi_CentralAsia_LatLon)
# start to loop through years and months for bias correcting the monthly values.
for (yr in startY:endY){
  for (mon in 1:12){
    # Load corresponding tmean CHELSA Central Asia File
    if (mon<10){
      chelsa_data_orig <- 
        raster(paste0(dir_CHELSA,dataType_ERA5,'/CHELSA_prec_',yr,'_0',mon,'_CA_V1.2.1.tif'))
      numbPrefix <- '_0'
    } else {
      chelsa_data_orig <- 
        raster(paste0(dir_CHELSA,dataType_ERA5,'/CHELSA_prec_',yr,'_',mon,'_CA_V1.2.1.tif'))
      numbPrefix <- '_'
    }
    chelsa_data_orig_resamp <- raster::resample(chelsa_data_orig,pbcorr_monthly_basin_longlat)
    chelsa_data_bcorr_resamp <- overlay(chelsa_data_orig_resamp,subset(pbcorr_monthly_basin_longlat,mon),
                                        fun=function(x,y){return(x*y)})
   # write bias corrected CHELSA back to the disk.
    raster::writeRaster(chelsa_data_bcorr_resamp,
                        paste0(dir_CHELSA,dataType_ERA5,'/CHELSA_tp_bcorr_',yr,numbPrefix,mon,'_CA_V1.2.1.tif'),
                        'GTiff',
                        varname   = dataType_ERA5,
                        overwrite = TRUE)
    #chelsa_data_bcorr_resamp %>% plot()
  }
}
```

### Computing Mean Monthly Temperature Climatology from CHELSA v1.2.1 data

The following code take CHELSA_V1.2.1 mean monthly temperature raster data and computes long-term mean monthly temperatures over the Central Asia domain. The resulting file can optionally be stored on the disk.

```{r, eval=FALSE}
fDir <- '../HydrologicalModeling_CentralAsia_Data/CentralAsiaDomain/CHELSA_V1.2.1/'
# First, we process and display mean monthly 2 meters temperatures.
varDir <- 't2m/'
t2m_files <- list.files(paste0(fDir,varDir))
# Get monthly fields and average over all data for resulting climatology
idxSeq <- seq(1,409,12)
for (idx in (1:12)){
  print(months[idx])
  t2m_files_sel <- t2m_files[idxSeq]
  for (idxRaster in (1:length(t2m_files_sel))){
    if (idxRaster == 1){
      raster_res <- raster::raster(paste0(fDir,varDir,'/',t2m_files_sel[1]))
    } else {
      raster_n <- raster::raster(paste0(fDir,varDir,'/',t2m_files_sel[idxRaster]))
      raster_res <- raster::addLayer(raster_n,raster_res)
    }
    raster_res_mean <- calc(raster_res, fun = mean)
  }
  if (idx ==1){
    raster_res_mean_stack <- raster_res_mean
  } else {
    raster_res_mean_stack <- raster::addLayer(raster_res_mean_stack,raster_res_mean)
  }
  idxSeq  <- idxSeq + 1
}

names(raster_res_mean_stack) <- month.abb

# raster::writeRaster(raster_res_mean_stack,
#                         paste0(fDir,'t2m_climatology/t2m_climatology_CA.tiff'),
#                         options="INTERLEAVE=BAND",
#                         'GTiff',
#                         varname   = 't2m',
#                         overwrite = TRUE)
```

### ERA5




## Appendix D: Solutions to exercises {#sectin-appendix-solutions}

### Exercise on Linear Reservoir modelling {#section-appendix-solutions-exercise1}
#### Task 1 {#solution-task1-experimental-setup}  

##### What will determine the flow through your bucket?  
The flow through the bucket will be influenced by the volume to bottom area fraction of the bucket, the amount and speed of water added to the bucket and the size of the outlet hole. 

##### What do you need to measure?   
You will need to measure:   

* the discharge from your bucket over time,  
* the recharge volume (how much water you put into the bucket over a given time),   
* the time when you start pouring water and when you stop pouring water into the bucket,  
* the approximate volume of your bucket.  

##### How can you measure it? 
This depends on what you have available. You can draw a water level line outside of your outflow receptacle every 10 seconds and then determine the volume change over time. Maybe you have a scale and a smart phone so you can put your outflow receptacle on the scale and make a movie of the weight change over time (1kg of water is approximately 1l of water).   
For the inflow pour a well defined volume over a well defined time interval. You can do this manually unless of course you have pipes and valves lying around that you can use.   
You will need a watch for measuring time and a receptacle with known volume to measure volumes (or a scale).    
A couple of notes on measurement accuracy:   

* Generally, the larger the volumes, the smaller the relative measurement error. Say you measure a discharge of 50ml in 1s (i.e. 50ml/s) and you can read your volume with an accuracy of 5ml and the time with an accuracy of 0.2s. Your measurement uncertainty becomes 11ml/s which is more than 20% of your discharge. If on the other hand, you measure 500ml over 10s (which is the same discharge of 50ml/s) with the same inaccuracies for volume and time your measurement uncertainty for discharge becomes 1ml/s which is only 2% of your discharge.  
* How do you estimate measurement uncertainties: Measure several times, compute the average and the standard deviation of your measurements assuming a student-t distribution.   
* How do you combine uncertainties of volume and time to the uncertainty of discharge: By applying Gaussian error propagation.   

##### What materials you will need to set up the experiment?
* For the bucket (the linear reservoir): A plastic bottle, a box or a can that is no longer used. It should have an opening at the top and the material should repel water and be thin enough that you can drill a hole into the wall.   
* A pair of pointy scissors or a knife to drill a hole into the bucket.   
* A water source (a tap, hose or a water container larger than the one above). This will be your rain machine.   
* A watch to measure time.  
* Note paper and pen.   
* A receptacle for measuring the outflow.   
* Additional material to facilitate measurement according to availability.   

```{r fig-solution1-example-setup, echo=FALSE, fig.show = "hold", out.width="90%", fig.align="center", fig.cap="Example for material needed and example setup to perform the linear reservoir experiment. Add a minion with a stop watch or a smart phone to help you logging the discharge from the bucket. "}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig_experimentalSetup.jpg")
```

##### Where will you get the water from and can you re-use it after the experiment? 
This depends on your situation.   

Back to the [recap section](#section-rsminerve-why-model-introduction)


#### Task 2 {#solution-task2-perform-experiment}
The video was recorded with a smart phone. The weight of the outflow receptacle was noted down every second. The discharge is computed as the change of volume in the outflow receptacle over time.    

<iframe width="720" height="480" src="_bookdown_files/FIG_Appendix_QuickGuides/bucket_video.mp4" align="middle" frameborder="0" allowfullscreen></iframe>

Back to the [recap section](#section-rsminerve-why-model-introduction)


#### Task 3 {#solution-task3-simulate}
The height of the measured discharge peak can be best reproduced with k = 0.42. However, the measured discharge peaks 1s later than the simulated discharge peak.   
Reasons for the discrepancy can be the shape of the linear reservoir, non-linear pouring speed, and measurement uncertainties.       

Back to the [recap section](#section-rsminerve-why-model-introduction)

#### Task 4 {#solution-task4-think}
ToDo       

Back to the [recap section](#section-rsminerve-why-model-introduction)



### Exercises on the HBV model {#section-appendix-solutions-hbv-exercises}

#### Exercise: Driving forces of the HBV model {#section-appendix-solutions-hbv-driving-forces}
The model drivers are precipitation, temperature and evaporation (P, T and ET in Figure \@ref(fig:fig-overview-hbv-model)). You need to provide time series of the model drivers to the model. Evaporation is typically not measured at climate stations but many empirical functions are available in the literature to estimate evaporation. RS Minerve offers the possibility to calculate evaporation based on temperature measurements and catchment location (you will do that later in this tutorial).  

Back to the [HBV model section](#section-hbv-model)

#### Exercise - HBV model states {#section-appendix-solutions-hbv-parameters-states}
The model states are the snow water equivalent height (SWE), the relative water content in the snow pack (WH), the humidity (Hum), the upper reservoir water level (SU) and the lower reservoir water level (SL). The model states are initialised using the initial conditions (see Figure \@ref(fig:fig-overview-hbv-model-parameters)).   

Back to the [HBV model section](#section-hbv-model)

#### Exercise: Data visualization in RS Minerve   {#section-appendix-solutions-plot-temperature-and-precipitation-1984}
Simulate from the 01/01/1981 01:00:00 to 31/12/1983 23:00:00, then choose data from 31/12/1983 23:00:00 as the initial conditions and run the model from 01/01/1984 01:00:00 to 31/12/1984 23:00:00. Choose hourly output for the simulation results.   
Open the Selection and plots tab by clicking on the Selection and plots button in the Modules toolbar and select simulated P and T from the Nauvalisoy station (Figure \@ref(fig:fig-pt-nauvailsoy)). 
```{r fig-pt-nauvailsoy, echo=FALSE, out.width="95%", fig.align="center", fig.cap="Hourly precipitation and temperature at the virtual Nauvalisoy weather station."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig116_plotPThourly.png")
```

Note: If you want to repeat a simulation with specific initial conditions, you can store them through Export IC in the Model Properties toolbar. 

The approximate temperature range is -13 in December to 34 deg C in August. The annual precipitation is about 1.4m (visualize Pcum and click on the last value of the time series). No precipitation falls during the summer months.  

Back to the  [Nauvalisoy model setup section](#section-hbv-nauvalisoy-modelling-setup). 


#### Exercise: Compare evaporation methods {#section-appendix-solutions-compare-evaporation-methods}
Figure \@ref(fig:fig-evaporation-discharge) shows the evaporation computed with various methods and the resulting discharge. Uniform evaporation should not be used for sub-annual modeling time steps. The difference between the methods by Turc, McGuinness and Oudin are within 5% of total discharge which is negligible for a regional model.   
```{r fig-evaporation-discharge, echo=FALSE, out.width="95%", fig.align="center", fig.cap="Hourly precipitation and temperature at the virtual Nauvalisoy weather station."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig119_evaporationDischarge1984.png")
```
For advanced modeling, the choice of the evaporation model may be relevant but only if a validation with measured data is possible.   

Back to the  [Nauvalisoy model setup section](#section-hbv-nauvalisoy-modelling-setup). 


#### Exercise: Common difficulties in model calibration {#section-appendix-solutions-common-calibration-issues}
1. Especially fully and semi-distributed hydrological models are typically over-parameterized, i.e. the number of model parameters is much larger than the number of observations for the model states. The true parameter values of the system cannot be uniquely identified based on a discharge time series alone.   
2. The outcome of the calibration depends on the measure of similarity between the simulated and the measured discharge.   
3. The model is calibrated against historical data. Its ability to predict future discharge may be limited.  
4. The model is not perfect, it remains an approximation of the real system and may not incorporate all relevant processes of the hydrologic cycle (e.g. water storage and transport in glaciers for the case of the HBV model or significant sub-surface water fluxes that are unknown (for example in Karst regions)).  
5. Discharge measurements typically have uncertainties of 20%. Particularly measurements at the lower and upper ends of the rating curve (i.e. the water table - discharge relationship) are typically prone to larger uncertainties (bonus question: think about why this is so!). Is the measurement location or the equipment not properly maintained, biases may grow over time. On the other hand, if the measurement method is updated and changed, the measured discharge may display a different pattern (for an example, look at the low flow of the discharge of the river Gunt in Figure \@ref(fig:GuntMonthlyQ)).  

Back to the [calibration section](#section-calibration-principles)

#### Exercise: Strategies to overcome some of the model calibration difficulties {#section-appendix-solutions-strategies-for-issues}

1. Over-parameterization:   
  + Consider simplifying the model, i.e. reducing the number of parameters. If the model complexity is required,   
  + Collect data to verify individual fluxes of the model components (e.g. soil parameters, snow water equivalent, etc.). As physical measurements in the field are not always possible you may have to become creative here, e.g. use MODIS snow cover data to validate the snow/no snow partitioning of the HBV model. Also consult the literature for parameterizations of similar catchments.   
2. Use a combination of similarity measures. This will be demonstrated later on in the model calibration section.      
3. Exclude part of your data set from model calibration and use it for model validation. If the model does not perform well in the validation period, its parameters are too specific for the calibration period and the model is said to not generalize well. If this happens you should try to reduce the number of parameters in your model. To understand better which parameters are responsible for the over-fit of the historical discharge, use different calibration and validation periods and compare the resulting parameters. Through sensitivity analysis, identify the model components that are most sensitive to predicted changes of model forcings, geometry or parameterization and perform scenario analysis.   
4. Implement and validate multiple possible conceptual models. All of the models must be calibrated and validated individually.      
5. Square-root filters or data assimilation algorithms are able to account for non-correlated measurement errors (they are not implemented in RS Minerve and not topic of this course). Error bands for the measurements should be adapted when communicating model results.  

Most of the above points will be discussed in more detail during this course.  

Back to the [calibration section](#section-calibration-principles)


#### Exercise: Calibrate a simple HBV model {#section-appendix-solutions-calibrated parameters}
The parameter set of the calibrated model are: 

```{r, echo=FALSE,message=FALSE,warning=FALSE,error=FALSE}
calibrated_parameters <- read.delim("./data/SyrDarya/Chirchiq/RSMinerve/nauvalisoy_PAR_calibrated.txt", 
                                    header = TRUE, skip = 9, nrows = 1) 
calibrated_parameters <- calibrated_parameters[,4:dim(calibrated_parameters)[2]]
colnames(calibrated_parameters) <- c("CFMax (mm/°C/d)", "CFR (-)", "CWH (-)", 
                                     "TT (°C)", "TTInt (°C)", "TTSM (°C)", 
                                     "Beta (-)", "FC (mm)", "PWP (-)", 
                                     "SUMax (mm)", "Kr (1/d)", "Ku (1/d)", 
                                     "Kl (1/d)", "Kperc (1/d)")
print(knitr::kable(t(calibrated_parameters)))
```

You can import the calibrated parameters via Import P in the Model Properties toolbar (the calibrated parameters are available in ./data/SyrDarya/Chirchiq/RSMinerve/nauvalisoy_PAR_calibrated.txt. 

Back to the [practical calibration section](#secion-calibration-practical-steps)









# (APPENDIX) Appendix {#ChapterAppendix}

## Appendix A: Open-source resources {#section-appendix-open-source-resources}

### Literature
Many authors of scientific literature are on the web platform [researchgate](https://www.researchgate.net/) where they can privately share their work with students (users need to register for an account).

### QGIS {#section-open-resrouces-software-QGIS}
QGIS is a free and open source Geographical Information System that offers very similar tools as their commercial counterparts. The latest version of QGIS can be downloaded from the [QGIS website](https://qgis.org/en/site/). We recommend to install the stable long-term support version ([installation guide](#appendix-sofware-qgis-installation-guide)).  

#### Resources for learning QGIS {#section-open-resrouces-learning-QGIS}
A general tutorial for beginners is the  [QGIS training manual](https://docs.qgis.org/3.16/en/docs/training_manual/index.html). It includes a short chapter on the use of QGIS for hydrological analysis (Chapter 17.16). For this course you should be familiar with the QGIS window and know the difference between raster and vector data. If you have used QGIS or a similar GIS software before you will not need to do a tutorial prior to this course.  


### R and RStudio {#section-open-resrouces-software-R}
R is a free and open source statistical programming language. It's large user community ensure active development and up-to-date help resources available on the internet. RStudio is a free user interface for R. To install R and RStudio follow the installation guide on [ModernDive - Statistical Inference via Data Science](https://moderndive.com/index.html)

#### Resources for learning R and R studio {#section-open-resrouces-learning-R}
* “Help! I’m new to R and RStudio and I need to learn them! What do I do?” If you’re asking yourself this, this book is for you: [ModernDive - Statistical Inference via Data Science](https://moderndive.com/index.html). 
* A thorough guide for data science in R: [R for Data Science](https://r4ds.had.co.nz/index.html)   

### RS Minerve {#section-open-resrouces-software-RSMinerve}
#### How to download and install RS Minerve {#section-quickguides-how-to-download-and-install-rsminerve}
Go to the software download page of CREALP's website  [https://www.crealp.ch/fr/accueil/outils-services/logiciels/rs-minerve/telechargement-rsm.html](https://www.crealp.ch/fr/accueil/outils-services/logiciels/rs-minerve/telechargement-rsm.html) (last accessed March 18, 2021) and click on *Version actuelle* to download the latest installer for Windows (see Figure \@ref(fig:fig-download-rsminerve)). This will start the download process for the installer RSMinerve-install.exe. 

```{r fig-download-rsminerve, echo=FALSE, out.width="95%", fig.align="center", fig.cap="Download RS Minerve from the CREALP website [https://www.crealp.ch/fr/accueil/outils-services/logiciels/rs-minerve/telechargement-rsm.html](https://www.crealp.ch/fr/accueil/outils-services/logiciels/rs-minerve/telechargement-rsm.html) (last accessed March 18, 2021)."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig_downloadSiteRSMinerve.png")
```

You should also download the user manual (*RS MINERVE user manual*, written in English) and the example files used for the tutorials in the user manual (*Exemple de fichiers*, a zip file with data) as well as the technical manual (*RS MINERVE technical manual*, written in English).   
Once the installer is downloaded, install RS Minerve with a double-click on the installer and follow the Setup guide. Open RS Minerve once you have it installed. 

[Back to the prerequisites for RS Minerve modelling](#section-rsminerve-prerequisites)





## Appendix B: Quick Guides

### EE: Register for an account {#section-register-with-earth-explorer .unnumbered}

In your internet browser, navigate to <https://earthexplorer.usgs.gov/>.

```{r fig-earth-explorer-window, echo=FALSE, out.width="90%", fig.align="center", fig.cap="Start window of the Earth Explorer interface."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig400_EarthExplorerWindow.png")
```

Lick on *Login* in the top right corner. This will bring you to a new window where you can click on *Create New Account* which will open a form where you enter your information. After verifying your account by clicking on the appropriate link that you will be sent, you can download data from the Earth Explorer interface.

### EE: Download SRTM data for a selected region {#section-earth-explorer-download-srtm .unnumbered}

-   Login to the [Earth Explorer](https://earthexplorer.usgs.gov/) (Register if you haven't done so before [How to](#section-register-with-earth-explorer)).\
-   Navigate to your are of interest in the map panel of the Earth Explorer interface.\
-   Draw a polygon around your area of interest by clicking on the map (\@ref(fig:fig-earth-explorer-area-of-interest)).\

```{r fig-earth-explorer-area-of-interest, echo=FALSE, out.width="90%", fig.align="center", fig.cap="Define a polygon around your area of interest by clicking on the map."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig401_PolygonAroundAreaOfInterest.png")
```

-   In the Data Set tab, look for the SRTM 1 arc-second global DEM (\@ref(fig:fig-earth-explorer-search-data)) and select it by ticking the box next to the product name in the list.\

```{r fig-earth-explorer-search-data, echo=FALSE, out.width="90%", fig.align="center", fig.cap="Search for the SRTM 1 arc-second global DEM product."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig402_SearchSRTM1ArcSecondGlobal.png")
```

-   Verify that the result layer(s) cover your area of interest by pressing the foot icon in the Results tab and download if you are satisfied (\@ref(fig:fig-earth-explorer-results-download)).\

```{r fig-earth-explorer-results-download, echo=FALSE, out.width="90%", fig.align="center", fig.cap="Verify the results of your search and download the data products you need."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig404_verifyResultsDownload.png")
```

Back to the [Load DEM section](#section-geospatial-data-load-dem).


### QGIS installation guide {#appendix-sofware-qgis-installation-guide .unnumbered}
In your web browser go to [https://qgis.org/en/site/forusers/download.html](https://qgis.org/en/site/forusers/download.html) (Figure \@ref(fig:qgis-download-site)). 
```{r qgis-download-site, echo=FALSE, out.width="90%", fig.align="center", fig.cap="The QGIS download site."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig_download_site_qgis.png")
```

Choose the long-term support version of QGIS for your operating system (e.g. if you use a laptop with a 64-bit Windows operating system, open the *Download for Windows* tab and click on *QGIS Standalone Installer Version 3.16 (64 bit)*, see Figure \@ref(fig:qgis-installer-version-316)). Click on the installer will start the download. 
```{r qgis-installer-version-316, echo=FALSE, out.width="50%", fig.align="center", fig.cap="The QGIS installer if you work on a 64-bit Windows operating system."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig_qgis-installer-version-316.png")
```

Double-click on the downloaded file to start the installation. Typically, SAGA GIS and GRASS GIS are installed alongside QGIS. 



### The QGIS window - overview {#section-qgis-window-overview .unnumbered}

The main parts of the QGIS window which are referenced in this tutorial, are highlighted in \@ref(fig:qgis-window-overview).

```{r qgis-window-overview, echo=FALSE, out.width="90%", fig.align="center", fig.cap="The QGIS window."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/0fig000_qgisWindowOverview.png")
```

### QGIS: Saving a new QGIS project {#section-saving-a-new-qgis-project .unnumbered}

Open your QGIS and open a new QGIS project by moving your cursor on the white sheet symbol in the upper-left corner of your QGIS window (\@ref(fig:qgis-open-qgis-project)).

```{r qgis-open-qgis-project, echo=FALSE, out.width="90%", fig.align="center", fig.cap="Tutorial project open in QGIS LTS."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/0fig001_OpenNewProject.png")
```

Save the QGIS project by pressing on the floppy disk icon and selecting a location for the file on your computer and a name for the project. You can [add freely available on-line maps as background](#section-loading-public-background-layers).

Back to [setting up of QGIS](#section-geospatial-data-steps-setting-up).

### QGIS: Change the projection of the QGIS project {#section-change-project-projection-qgis .unnumbered}

For this tutorial, the projection of the QGIS project should be in EPSG:32642. Change it by clicking on the projects projection in the lower right corner of the QGIS window (see Figure \@ref(fig:qgis-window-overview)). In the coordinate reference system (CRS) tab of the Project Properties, select WGS84 / UTM zone 42N with ID EPSG:32642 and click *OK*.  

For modeling your own sample catchment, a different UTM zone may be applicable. The map in the lower right corner of the Project Properties window shows the area for the projection in red and the area where your data is located in violet so you can visually verify that you choose an appropriate projection. Large parts of Kyrgyzstan are in the UTM zone 43N (EPSG:32643). 

Back to the [setting up of QGIS](#section-geospatial-data-steps-setting-up).

### QGIS: Install and activate plugins in QGIS3 {#section-install-and-activate-plugins-in-QGIS3 .unnumbered}

Navigate to *Plugins* in the header toolbar and go to *Manage and Install Plugins ...*. Search for the plugin name and go to *Install Plugin* to install a plugin or tick the box to the left of the plugin name in the list of plugins to activate it (\@ref(fig:fig-install-activate-qgis-plugin)).

```{r fig-install-activate-qgis-plugin, echo=FALSE, out.width="80%", fig.align="center", fig.cap="Plugin management window in QGIS 3.16. Install plugin with the `Install Plugin` button. Activate installed plugins by ticking the box in the list."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig301_InstallAndActivatePluginsInQGIS3.png")
```

Back to the [setting up of QGIS](#section-geospatial-data-steps-setting-up).


### GQIS: Managing panels visibility in QGIS {#section-managing-panels .unnumbered}

Should one of the panels described here not be visible in your QGIS window navigate to *View* in your header toolbar and move to Panels. The visible panels are marked with a tick. Click on a panel name in the list to activate or deactivate it.

Back to [setting up of QGIS](#section-geospatial-data-steps-setting-up).


### QGIS: Loading public background maps {#section-loading-public-background-layers .unnumbered}

You can add freely available on-line maps as backgrounds. Note that they will only be available as long as your computer is connected to the internet. In the *Browser* panel ([What to do if you don't see the *Browser* panel](#section-managing-panels)), move the cursor to *XYZ Tiles*, do a right-click and select *New Connection*. Enter a descriptive name for the map layer and one of the links below and click *OK*. The new map layer will appear under *XYZ Tiles*. By double-clicking on the layer you can add it to your Layers panel.

Back to [setting up of QGIS](#section-geospatial-data-steps-setting-up).


### QGIS: Zoom to layer {#section-zoom-to-layer .unnumbered}

You can tell QGIS to zoom to the selected layer by selecting a layer in the *Layers* window and then on the white sheet and magnifying glass icon in the toolbar (\@ref(fig:qgis-zoom-to-layer)).

```{r qgis-zoom-to-layer, echo=FALSE, out.width="100%", fig.align="center", fig.cap="Zoom to layer."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig009_ZoomToLayer.png")
```

You can also perform a right-click on the layer name in the *Layers* panel and select *Zoom to layer*.


### QGIS: Import SRTM layers using the SRTM plugin {#section-srtm-plugin .unnumbered}

Make sure the SRTM plugin is installed ([How to](#section-install-and-activate-plugins-in-QGIS3)). Navigate to *Plugins* in the header toolbar and there to *SRTM Downloader*. Select the *SRTM Downloader*. Set the boundaries of the SRTM tiles to download and press the *Download* button. Close the window when done. The SRTM tiles are loaded to the Layers pane.

Back to [Load DEM in QGIS section](#section-geospatial-data-load-dem)


### QGIS: Merge SRTM tiles to a single layer {#section-merge-srtm-tiles .unnumbered}

Navigate to *Raster* in the header toolbar and then to *Miscellaneous* and *Merge...*. In the *Merge* window that opens, select the input layers by clicking on the *...* button. Tick the layers that need to be merged and press *Run*. When the algorithm is done, close the window. You can zoom to the extent of the new layer [How to](#section-zoom-to-layer). You can change the color of the DEM file.

Back to [Load DEM in QGIS section](#section-geospatial-data-load-dem)


### QGIS: Add raster layer {#section-quick-guides-load-dem .unnumbered} 
In your QGIS window, navigate to *Layer* in your header toolbar, there to *Add Layer* and left-click on *Add Raster Layer* (see Figure \@ref(fig:qgis-add-raster-layer-1)). The Data Source Manager will open in a pop-up window (see Figure \@ref(fig:qgis-add-raster-layer-2)). 
```{r qgis-add-raster-layer-1, echo=FALSE, out.width="90%", fig.align="center", fig.cap="Add raster layer to QGIS project, step 1.: Navigate to the Data Source Manager."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig_add_raster_layer_001.png")
```


```{r qgis-add-raster-layer-2, echo=FALSE, out.width="60%", fig.align="center", fig.cap="Add raster layer to QGIS project, step 2.: Browse for the raster file to add to the QGIS project by pressing on the box with the three dots (...) to the right of the raster source input field."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig_add_raster_layer_002.png")
```

In the example above, a DEM for the example of the Nauvalisoy river catchment is loaded. For loading the DEM of your sample catchments, browse for the DEM you downloaded from the *learningFiles* directory.   

Press the *Add* button at the bottom right of the Data Source Manager window to load the raster layer to your QGIS project and close the window by pressing the *Close* button (to the left of the *Add* button).  

Your QGIS project now shows a grey-scale version of the raster layer you loaded. If you are satisfied with the change, save your porject by pressing the floppy disk icon at the upper left corner of your QGIS window.   

You can change the color of your raster file ([how to](#appendix-quick-guides-change-color-of-raster-layer)). [Here](#appendix-quick-guides-topograpy-color-ramp) is a quick-guide of how to apply a topography-style color band to your DEM. 


### QGIS: Change color of raster layer {#appendix-quick-guides-change-color-of-raster-layer .unnumbered}

You can change the colors of your cut DEM by double-clicking on the layer name in the *Layers* window. Go to tab *Symbology* (with the paint and brush icon) and choose *Render type* *Singleband-pseudocolor* (Figure \@ref(fig:qgis-dem-coloring-1)) and select a *Color ramp*.

```{r qgis-dem-coloring-1, echo=FALSE, out.width="80%", fig.align="center", fig.cap="Nicely color your DEM, step 1."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig013_DEMcoloring1.png")
```

QGIS comes with a large library of color ramps but you can also create your own. See below a description of how to get your DEM in a topography style color palette. 

#### QGIS: Topography-style color palettes {#appendix-quick-guides-topograpy-color-ramp .unnumbered}

For our DEM we choose an existing topography-style color ramp. Open the *Layer Properties* window with a double-click on the raster layer in the *Layers* pane of the QGIS window. In the *Symbology* tab click the triangle to the right of the color ramp and select Create New Color Ramp... (Figure \@ref(fig:qgis-dem-coloring-2)).

```{r qgis-dem-coloring-2, echo=FALSE, out.width="80%", fig.align="center", fig.cap="Nicely color your DEM, step 2."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig014_DEMcoloring2.png")  
```

In the drop down menu of the pop-up window choose Catalog: cpt-city and press OK (Figure \@ref(fig:qgis-dem-coloring-3)).

```{r qgis-dem-coloring-3, echo=FALSE, out.width="20%", fig.align="center", fig.cap="Nicely color your DEM, step 3."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig015_DEMcoloring3.png")  
```

A this will open another window containing the catalog of existing color ramps. Under Topography, we choose sd-a and press OK (Figure \@ref(fig:qgis-dem-coloring-4)).

```{r qgis-dem-coloring-4, echo=FALSE, out.width="80%", fig.align="center", fig.cap="Nicely color your DEM, step 4."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig016_DEMcoloring4.png")  
```

Go to tab Transparency, set Global Opacity to 30% and specify the No Data Value 0 (Figure \@ref(fig:qgis-dem-coloring-5)).

```{r qgis-dem-coloring-5, echo=FALSE, out.width="80%", fig.align="center", fig.cap="Nicely color your DEM, step 5."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig017_DEMcoloring5.png")  
```

Then go back to the Symbology tab. The minimum value of the color ramp should now not be 0 but 272. Adapt manually if need be. Then, press classify to get a discrete color ramp for your map and *Apply* to the map. If you are happy with the colors, quit by pressing OK (Figure \@ref(fig:qgis-dem-coloring-6)).

```{r qgis-dem-coloring-6, echo=FALSE, out.width="80%", fig.align="center", fig.cap="Nicely color your DEM, step 6."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig018_DEMcoloring6.png")  
```

The result will look like Figure \@ref(fig:qgis-dem-coloring-7).

```{r qgis-dem-coloring-7, echo=FALSE, out.width="100%", fig.align="center", fig.cap="Nicely color your DEM, result."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig019_DEMcoloring7.png")  
```

You can add decorations (e.g. scale and north arrow) to your map ([how to](#section-add-map-decorations)). 


### QGIS: Add map decorations {#section-add-map-decorations .unnumbered}

Navigate to *View* -\> *Decorations* and choose among the decorations to add. Many options for configuring the decorations are available.


### QGIS: Verify projection of layer and re-project layer {#section-quick-guides-verify-projection-reproject}

Open the *Layer Properties* window with a double-click on the layer in the *Layers* pane and navigate to the *Information* tab. Under CRS (coordinate reference system) you see the projection of the layer. For the Chirchiq river basin, the CRS should say "EPSG:32642 - WGS 84 / UTM zone 42N - Projected". Other river catchments in Central Asia may require a different UTM zone.   

A raster layer can be re-projected to a different CRS: Go to *Raster* in the header toolbar. From there move the cursor over *Projections* and click on *Warp (Reproject)...*. The Warp window will pop up. Select the raster layer you wish to re-project in the *Input layer* and select the *Target CRS*. If the target CRS you wish to re-project to is not available in the drop-down menue, you can browse for it by clicking on the globe icon to thr right of the *Target CRS* section. You may re-sample the raster to a coarser resolution by specifying the *Output file resolution*. You may also specify to save the re-projected raster layer: Scrol to the bottom of the *Warp (Reproject)* window where you see Reprojected and a white box where you can browser for a location to store the new layer to. If you do not specify a target location, only a temporary layer will be loaded to QGIS which will not be available anymore after you close the QGIS project (even if you save the project). You may decide to load the temporary file and save it later ([how to](#appendix-quick-guide-save-temp-layer)). Click the *Run* button at the bottom right to start the re-projection algorithm and press *Close* when the process is done. The re-projected layer will be available in the *Layers* pane.    

A vector layer can be re-projected by selecting *Vector* in the header toolbar, moving the cursor to *Data Management Tools* and clicking on *Reproject Layer...*. This opens the *Reproject Layer* window where you can specify a *Target CRS* and optionally a storage location. As for the re-projection of the raster layer, a temporary layer is loaded to your QGIS project if you do not specify a storage location. However, you can always store temporary layers later ([how to](#appendix-quick-guide-save-temp-layer)). 

Back to the [load DEM section](#section-geospatial-data-load-dem). 


### QGIS: Save a temporary layer {#appendix-quick-guide-save-temp-layer .unnumbered}
Right-click on a temporary layer in the *Layers* pane. Temporary layers are indicated by a box to the right of the layer name. From the menu that opens upon right-click, select *Export* and *Save As...* (for raster layers) or *Save Feature As...* (for vector layers). An explorer window will open where you can specify a file name and a location to store the file to. 


### QGIS: Add vector layer {#section-add-vector-layer-to-qgis .unnumbered}

Left-clicking on *Layer*, moving your cursor over *Add Layer* and left-clicking *Add Vector Layer* (Figure \@ref(fig:qgis-add-vector-layer-1)).

```{r qgis-add-vector-layer-1, echo=FALSE, out.width="100%", fig.align="center", fig.cap="Add vector layer to QGIS project, step 1.: Navigate to the Data Source Manager."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig003_AddVectorLayer1.png")
```

A window will pop up, asking you to specify the properties of the vector layer to add (\@ref(fig:qgis-add-vector-layer-2)).

```{r qgis-add-vector-layer-2, echo=FALSE, out.width="70%", fig.align="center", fig.cap="Add vector layer to QGIS project, step 2: Select vector layers to add. Note that you select the *shp* file but *cpg*, *dbf* and *shx* need to be present in the same location."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig004_AddVectorLayer2.png")
```

Press the box with the three dots on the right of the source field to specify the location of the shape file to be added to your project (\@ref(fig:qgis-add-vector-layer-3)). Click *Open* and the window will close. The address of your shape files should now stand in the source field as in \@ref(fig:qgis-add-vector-layer-2).

```{r qgis-add-vector-layer-3, echo=FALSE, out.width="60%", fig.align="center", fig.cap="Add vector layer to QGIS project, step 3."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig005_AddVectorLayer3.png")
```

Note that you load the *.shp* file but that all the files in the list in \@ref(fig:qgis-add-vector-layer-2) need to be present. In the *Add Vector Layer* window, click *Add* and then close the window. QGIS has attributed a random color to your shape file which can be changed manually [How to](#section-change-color-of-vector-layer).

### QGIS: Change color of a vector layer {#section-change-color-of-vector-layer .unnumbered}

You can change the color of your layer by double-clicking on the layer name in the *Layers* Window to the left of the map. This will open the properties window. The third tab from the top shows paint and brush (\@ref(fig:qgis-add-vector-layer-5)).

```{r qgis-add-vector-layer-5, echo=FALSE, out.width="50%", fig.align="center", fig.cap="Add vector layer to QGIS project, step 5. Change the color of the layer."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig007_AddVectorLayer5.png")
```

You can activate *Simple fill* by clicking on it and select *No brush* in the drop-down menu in order to only show the outline of your vector layer (\@ref(fig:qgis-add-vector-layer-6)).

```{r qgis-add-vector-layer-6, echo=FALSE, out.width="50%", fig.align="center", fig.cap="Add vector layer to QGIS project, step 6. Only show the outline of the vector layer."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig008_AddVectorLayer6.png")
```



### QGIS: Fill sinks {#appendix-quick-guides-fill-sinks .unnumbered}
Browse for the *Fill sinks* algorithm in the *Processing Toolbox* panel (Figure \@ref(fig:qgis-fill-sinks-1)). If the *Processing Toolbox* panel is not visible go to *Processing* in the header toolbar and click on *Toolbox* to activate it. Alternatively, [here](#section-managing-panels) is how to manage the visibility of panels in QGIS. 
```{r qgis-fill-sinks-1, echo=FALSE, out.width="90%", fig.align="center", fig.cap="Search for the *Fill sinks* algorithm in the *Processing Toolbar* panel."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/1fig_fillSinks.png")
```

Open the *Fill sinks* window with a double-click on the name of the algorithm in the *Processing Toolbar* panel. There, select the DEM you want to process and browse for a location to store the output file to (Figure \@ref(fig:qgis-fill-sinks-2)). You can leave the default minimum slope.   
```{r qgis-fill-sinks-2, echo=FALSE, out.width="90%", fig.align="center", fig.cap="Select the raster file to process."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/1fig_fillSinks2.png")
```

When the algorithm is done it will load the new layer into your QGIS project. Close the *Fill sinks* window and save your project. 


Back to [catchment delineation](#section-steps-derive-catchment-boundaries). 


### QGIS: Managing panels visibility in QGIS {#section-managing-panels .unnumbered}

Should one of the panels described here not be visible in your QGIS window navigate to *View* in your header toolbar and move to Panels. The visible panels are marked with a tick. Click on a panel name in the list to activate or deactivate it.


### QGIS: Calculate the area upslope of a point {#appendix-quick-guide-upslope-area .unnumbered}
Search for the SAGA algorithm *Upslope Area* in the *Processing Toolbox* panel and open the function window with a double click on the name. Enter the Longitude of your discharge station for the Target X coordinate and the Latitude for the Target Y coordinate. For the Elevation select the sink-filled DEM ([how to fill sinks in a DEM](#appendix-quick-guides-fill-sinks), [why we need to fill in sinks](#section-why-fill-sinks-dem)). All GIS layers and the coordinates of the discharge gauge need to be in the same UTM projection. Choose a method in the drop-down menue in the *Method* section and optionally specify a location for the output file. For the example of the Nauvalisoy basin, the *Upslope Area* window filled in correctly is shown in Figure \@ref(fig:qgis-upslope-area-window). 
```{r qgis-upslope-area-window, echo=FALSE, out.width="50%", fig.align="center", fig.cap="The *Upslope Area* window for the determination of the catchment area of the Nauvalisoy river basin."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/1fig_upslopeAreaWindow.png")
```

Click *Run* and *Close* after the algorithm is done. A new raster file with the values 0 for outside the catchment area and 100 for inside the catchment area is now loaded into your QGIS project. 

Back to [catchment delineation](#section-steps-derive-catchment-boundaries). 

### QGIS: {#appendix-quick-guide-polygonize .unnumbered}
Got to *Raster* in the header toolbar, move your cursor over *Conversion* and click on *Polygonize (Raster to Vector)...* (see Figure \@ref(fig:qgis-open-polygonize-window)).
```{r qgis-open-polygonize-window, echo=FALSE, out.width="90%", fig.align="center", fig.cap="Open the *Polygonize* window."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/1fig_polygonize1.png")
```

Select the raster layer you wish to polygonize (for example the upslope area raster layer) and run the process. Close the polygonize window after the algorithm is done. A new shape file will be loaded to your GIS project (Figure \@ref(fig:qgis-raw-polygonized-layer)).   
```{r qgis-raw-polygonized-layer, echo=FALSE, out.width="90%", fig.align="center", fig.cap="The vector layer generated by a raster to vector conversion."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/1fig_polygonize2.png")
```

The new vector layer has 2 features: the watershed boundary and a box around the watershed the same size of the DEM we used. To get rid of the outer shape, open the attribute table with a right-click on the vector layer and selecting *Open Attribute Table*. In the attribute table, elect the outer shape by clicking on the second row of the attribute table and toggle the edit mode by clicking on the pen icon (Figure \@ref(fig:qgis-attrib-table-toggle-edit)). 
```{r qgis-attrib-table-toggle-edit, echo=FALSE, out.width="90%", fig.align="center", fig.cap="Select the outer shape to discard by clicking on the second row in the attribute table and toggle the edit mode by clicking on the pen icon. "}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/1fig_polygonize3.png")
```

Delete the outer shape by pressing the red bin icon in the attribute table (Figure \ref(fig:qgis-delete-selected-features)). 
```{r qgis-delete-selected-features, echo=FALSE, out.width="90%", fig.align="center", fig.cap="Delete the selected outer shape."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/1fig_polygonize4.png")
```

Save the edits in the attribute table (see Figure \@ref(fig:qgis-save-edits-attribute-table) and press the pen icon again to un-toggle the edit mode. 
```{r qgis-save-edits-attribute-table, echo=FALSE, out.width="90%", fig.align="center", fig.cap="Save your edits in the attribute table."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/1fig_polygonize5.png")
```
Close the attribute table window and save the boundary of your watershed and your QGIS project. 

Back to [catchment delineation](#section-steps-derive-catchment-boundaries). 



### RSM: Create HBV model and edit parameters {#section-quickguides-create-hbv-model .unnumbered}  
Click on the HBV model icon in the model selection panel (Figure \@ref(fig:fig-create-hbv-model)). 
```{r fig-create-hbv-model, echo=FALSE, out.width="50%", fig.align="center", fig.cap="To generate an HBV model, click on the HBV model icon in the model selection panel."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig100_HBVinModelSelectionPanel.png")
```

Move your cursor to the white area in the center and create a HBV model with a click. The HBV model icon will now appear in the white model panel (Figure \@ref(fig:fig-hbv-model-generated)). 
```{r fig-hbv-model-generated, echo=FALSE, out.width="95%", fig.align="center", fig.cap="A HBV model has been generated."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig101_HBVmodelGenerated.png")
```

Edit the parameters of the model by double-clicking on the model icon and changing parameter values in the table that appears to the right of the RS Minerve window (Figure \@ref(fig:fig-edit-hbv-model-single)). 
```{r fig-edit-hbv-model-single, echo=FALSE, out.width="95%", fig.align="center", fig.cap="Double-click on the HBV model to open and edit the parameter table. "}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig102_editParametersSingleModel.png")
```

Alternatively (especially if you have to change parameters for several models), activate the Parameters panel in the Model Properties toolbar (Figure \@ref(fig:fig-activate-parameters-panel)). 
```{r fig-activate-parameters-panel, echo=FALSE, out.width="95%", fig.align="center", fig.cap="Activate the Parameters panel in the Model Properties toolbar. "}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig103_activateParametersPanel.png")
```

Select the HBV model in the Parameters panel (Figure \@ref(fig:fig-select-hbv-parameters-panel)). 
```{r fig-select-hbv-parameters-panel, echo=FALSE, out.width="95%", fig.align="center", fig.cap="Select HBV in the Parameters panel."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig104_selectHBVparameters.png")
```

If you have several HBV models, you can select models by zone and apply edits in the parameter table in the left of the Parameters panel to all selected models (mark with tick). You can also edit paramers for individual models in the right-hand table of the Parameters panel (Figure \@ref(fig:fig-edit-hbv-parameters-panel)). 
```{r fig-edit-hbv-parameters-panel, echo=FALSE, out.width="95%", fig.align="center", fig.cap="Edit parameters for groups of models (left parameter table) or for individual models (right parameter table)."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig105_editParametersInParametersPanel.png")
```

Save your model by clicking the floppy disk icon in the toolbar.   

You can also export parameters to a text file via the button *Export P* in the Model Properties toolbar, edit the text file and import the edited parameter file through *Import P*.   

The area of the HBV model should be 99'000'000 m2.   

Back to the [Nauvalisoy model guide](#section-hbv-nauvalisoy-modelling-setup). 


### RSM: Add and link climate station {#section-quickguides-add-climate-station .unnumbered}
Move your cursor to the V-Station icon in the models panel (the first icon in Figure \@ref(fig:fig-create-hbv-model)). Click on the icon to activate it and click next to the HBV model in your model pane to place the V-Station. With a double-click on the newly created V-Station, you can visualize the parameters of the virtual weather station.   
Connect the station to the HBV model by activating the Connections mode in the Editing tools toolbar (Figure \@ref(fig:fig-connect-V-station1)). 
```{r fig-connect-V-station1, echo=FALSE, out.width="95%", fig.align="center", fig.cap="Create a virtual weather station."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig108_createVStation.png")
```

Click on the station, hold down the finger move your cursor to the HBV model, then release the hold. A grey line appeart between the station and the model and a pop-up window asks you to verify the data links between the two components (Figure \@ref(fig:fig-connect-V-station2)). 
```{r fig-connect-V-station2, echo=FALSE, out.width="95%", fig.align="center", fig.cap="Link the virtual weather station to the HBV model."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig109_linkVStation.png")
```
Click Ok to accept the suggested data links and a blue arrow will appear between the weather station and the model. Click on the black arrow in the Editing tools toolbar to leave the Connections model.     

Back to the [Nauvalisoy model guide](#section-hbv-nauvalisoy-modelling-setup). 


### RSM: Import climate data {#section-quickguides-import-climate-data .unnumbered}
Go to the database tab and click on Open in the File database toolbar (Figure \@ref(fig:fig-open-database-tab)).  
```{r fig-open-database-tab, echo=FALSE, out.width="95%", fig.align="center", fig.cap="The database tab."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig110_databasetab.png")
```

Select the file./data/SyrDarya/Chirchiq/RSMinerve/ERA5_Nauvalisoy_1981_2013.csv. If you don't see the file in your file browser, make sure the file ending .csv is selected in the file browser (Figure \@ref(fig:fig-open-database-tab-csv)).

```{r fig-open-database-tab-csv, echo=FALSE, out.width="60%", fig.align="center", fig.cap="Make sure the file ending is .csv in the file browser."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig111_dbfileEnding.png")
```

Press open to load the data into RSMinerve. Depending on your computer this may take a few seconds. Once the data is loaded, click through the database browser in the left pane to explore the data (Figure \@ref(fig:fig-explore-db)).
```{r fig-explore-db, echo=FALSE, out.width="60%", fig.align="center", fig.cap="Explore the data base."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig112_exploreDataDB.png")
```

To connect the data base to the model you will need to make the data consistent with the model. To do this change the name "New group" to "Measurements" and select Input for the category (Figure \@ref(fig:fig-db-measurements)). 
```{r fig-db-measurements, echo=FALSE, out.width="60%", fig.align="center", fig.cap="Change \"New group\" to \"Measurements\" and select Input as category."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig113_changenewdata.png")
```

Browse the name of the station (Figure \@ref(fig:fig-station-name-db)). 
```{r fig-station-name-db, echo=FALSE, out.width="60%", fig.align="center", fig.cap="The name of the station is \"Nauvalisoy\"."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig114_stationName.png")
```

As our weather data is representative for the entire Nauvalisoy catchment, the station name in the data base needs to be consistent with the station name of the V-Station in the model pane. Change the name of the station in the model pane from V-Station to Nauvalisoy by clicking on the name.   

Choose the nauvalisoy data set as source and adapt the simulation period as shown in Figure \@ref(fig:fig-validate-model). 
```{r fig-validate-model, echo=FALSE, out.width="60%", fig.align="center", fig.cap="Choose the nauvalisoy data set to link the weather station data to the virtual weather station. The simulation times should not extend the period of the input data. Simulation time step is 1 hour and the recording time step is 1 month."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig115_solverspecs.png")
```

Click on *Validation* to verify that the model has been set up correctly. Once you have adapted the model settings to calculate evaporation based on temperature ([how to](#section-quickguides-atapt-model-settings)), no errors should be reported. You can now run the model. A warning tells you that the number of meteo stations is not sufficient. Ignore the warning for now. 

[Nauvalisoy model guide](#section-hbv-nauvalisoy-modelling-setup)


### RSM: Adapt model settings {#section-quickguides-atapt-model-settings .unnumbered}
Navigate to Edit in the Settings toolbar (Figure \@ref(fig:fig-open-settings-tab)). 
```{r fig-open-settings-tab, echo=FALSE, out.width="95%", fig.align="center", fig.cap="Open the models settings tab."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig106_openSettingsTab.png")
```

Open the Settings tab and choose an ET model. Adapt the coordinates of the project (choose the station coordinates mentioned in the introduction section) (Figure \@ref(fig:fig-change-settings)). 
```{r fig-change-settings, echo=FALSE, out.width="95%", fig.align="center", fig.cap="Edit the evaporation calculation method and the coordinates of the project."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig107_changeSettings.png")
```
   
Back to the [model guide](#section-modelling-setup)


### RSM: Export simulation results to data base {#section-export-sim-results-to-db .unnumbered}
Go to Export in the Database toolbar (Figure \@ref(fig:fig-export-to-db)). Define a name for the simulation results and choose a data base group to save the data to. Create a new group if you haven't already done so. 

```{r fig-export-to-db, echo=FALSE, out.width="95%", fig.align="center", fig.cap="Export simulation results to the data base."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig117_exportResultsToDB.png")
```

The data sets are now available in the data base tab and can be visualized in the Selection and plots tab.  

Back to the [model guide](#section-modelling-setup)


### RSM: Add comparator and load discharge measurements {#section-quickguides-add-comparator-and-discharge-data .unnumbered}
The comparator object allows the user to compare a simulated variable to a reference. In our case, we want to compare the simulated discharge of the Nauvalisoy river to the measured one. The measured discharge can be imported to RS Minerve via the database tab.  
Move your cursor to the comparator icon (Figure \@ref(fig:rsminerve-comparator-icon)) in the model components panel. 
```{r rsminerve-comparator-icon, echo=FALSE, out.width="10%", fig.align="center", fig.cap="Comparator icon in RS Minerve."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig_comparator_icon.png")
```

Activate it with a right-click and move your cursor next to the HBV model in the model pane. Place the comparator object with another click. 

Add a source object to your model following the same procedure as for the comparator object. Figure \@ref(fig:rsminerve-source-icon) shows the icon of the source object.  
```{r rsminerve-source-icon, echo=FALSE, out.width="10%", fig.align="center", fig.cap="Comparator icon in RS Minerve."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig_source_icon.png")
```

You can now optionally rename your model objects.   

Connect the source and the HBV model to the comparator by activating the Connections mode in the Editing Tools toolbar. Right-click on the HBV model, hold the click and drag the cursor to the comparator object where you release the cursor. You will be asked in a pop-up window to specify the flow your wish to compare and if it is to be viewed as a simulation result or the reference. Connect the total discharge computed by the HBV model component as simulation result to the comparator (Figure \@ref(fig:rsminerve-connect-hbv-comparator)) and close the pop-up window by pressing OK. 
```{r rsminerve-connect-hbv-comparator, echo=FALSE, out.width="60%", fig.align="center", fig.cap="Comparator icon in RS Minerve."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig_connectHBVtoComparator.png")
```

Connect the source object to the comparator in the same way as the HBV object. The source will be connected as reference (Figure \@ref(fig:rsminerve-connect-source-comparator)).

```{r rsminerve-connect-source-comparator, echo=FALSE, out.width="60%", fig.align="center", fig.cap="Source icon in RS Minerve."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig_connectSourcetoComparator.png")
```

Next, we have to load the (synthetic) discharge data into the database. Navigate to the database tab. In the database, go to Measurements -> nauvalisoy and click *Add* and enter a name for the discharge station (Figure \@ref(fig:rsminerve-add-discharge-database)). For this example, we do not need to bother with the coordinates.  
```{r rsminerve-add-discharge-database, echo=FALSE, out.width="60%", fig.align="center", fig.cap="Connect the outflow of the HBV model as simulation result to the comparator."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig_database_add_discharge_station.png")
```

Under the new discharge station, add a sensor and rename it to the source object in your model (Figure \@ref(fig:rsminerve-add-discharge-sensor)). 
```{r rsminerve-add-discharge-sensor, echo=FALSE, out.width="60%", fig.align="center", fig.cap="Connect the discharge measurements (source) as reference to the comparator."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig_add_discharge_sensor.png")
```

Open the tab with the Values. Here we need to import the discharge data. You can do that by opening the discharge data in a spreadsheet (e.g. Excel) and copy-pasting the dates and discharge values into the Values table in RS Minerve ([Here is how to do this step-by-step](#section-quickguides-copy-paste-database-values). 

Now we need to link the discharge data in the database to the source object in the model. Navigate to the model and 

```{r rsminerve-link-discharge-data-to-model, echo=FALSE, out.width="80%", fig.align="center", fig.cap="Select the data source for the source object (under Data Source in the left window pane) and select the sensor for discharge data for the source (under Source, Series identifier in the right window pane)."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig_connect_source_database_to_object.png")
```

Validate the model to see if the model setup went correctly. Run the model if the validation did not throw an error. 


Back to the [practical model calibration and validation section](#secion-calibration-practical-steps)


### RSM: Copy-paste data to database {#section-quickguides-copy-paste-database-values .unnumbered}
Open the file ./data/SyrDarya/Chirchiq/RSMinerve/synthetic_discharge_Nauvalisoy_river_for_calibration_exercise.csv in a spreadsheet software, e.g. Excel, Numbers, Google Sheets or OpenOffice Calc and select the rows containing dates and values (Figure \@ref(fig:fig-copy-spreadsheet-data)). Press control C or perform a left-click and choose copy. 

```{r fig-copy-spreadsheet-data, echo=FALSE, out.width="40%", fig.align="center", fig.cap="Select the rows and columns containing the dates and data to be copied. Press control C to copy the selected cells."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig000_copy_data_spreadsheet.png")
```

Then navigate to the discharge sensor on the database tab in RS Minerve where you want to add the data to. Click in the small square to the left of the first row in the Values tab and enter control P. Alternatively perform a right-click in the small square and select Paste. The dates and values from the excel sheet will now appear in the table (Figure \@ref(fig:fig-paste-spreadsheet-data)). Save the database. 

```{r fig-paste-spreadsheet-data, echo=FALSE, out.width="40%", fig.align="center", fig.cap="Paste dates and values to the database table."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig000_paste_values_database.png")
```

Back to the [practical model calibration and validation section](#secion-calibration-practical-steps)




## Appendix C: Processing Climate Data

### Cutting CHELSA v.1.2.1 to CA Domain

The CHELSA v1.2.1 data is a global dataset. The data can be cut to the Central Asia domain in the following way.

```{r,eval=FALSE}
dir_CHELSA <- '/Users/tobiassiegfried/Dropbox (hydrosolutions)/1_HSOL_PROJECTS/PROJECTS/SDC/DKU_WRM_COURSE_CA/CourseMaterials/Data/CLIMATE/CHELSA_V1_2_1/'

# First, we process precipitation data (prec).
prec_CHELSA_files <- list.files(paste0(dir_CHELSA,'tp/'))
for (idx in 1:length(prec_CHELSA_files)){
  str2Print <- paste0('Processing PREC: ', idx, ' out of ', length(prec_CHELSA_files) )
  print(str2Print)
  fName <- prec_CHELSA_files[idx]
  global_CHELSA_raster <- raster(paste0(dir_CHELSA,'prec/',fName))
  centralAsia_CHELSA_raster <- raster::crop(global_CHELSA_raster,aoi_CentralAsia_LatLon)
  # Save the centralAsia_CHELSA_raster
  fName2Save <- paste0(substr(fName,1,19),'_CA',substr(fName,20,30))
  raster::writeRaster(centralAsia_CHELSA_raster,
                      paste0(dir_CHELSA,'prec/',fName2Save),
                      'GTiff',
                      overwrite = TRUE)
}

# Second, we process mean temperature data (tmean).
tmean_CHELSA_files <- list.files(paste0(dir_CHELSA,'t2m/'))
for (idx in 1:length(tmean_CHELSA_files)){
  str2Print <- paste0('Processing TMEAN: ', idx, ' out of ', length(tmean_CHELSA_files) )
  print(str2Print)
  fName <- tmean_CHELSA_files[idx]
  global_CHELSA_raster <- raster(paste0(dir_CHELSA,'tmean/',fName))
  centralAsia_CHELSA_raster <- raster::crop(global_CHELSA_raster,aoi_CentralAsia_LatLon)
  # Save the centralAsia_CHELSA_raster
  fName2Save <- paste0(substr(fName,1,20),'_CA',substr(fName,21,35))
  raster::writeRaster(centralAsia_CHELSA_raster,
                      paste0(dir_CHELSA,'tmean/',fName2Save),
                      'GTiff',
                      overwrite = TRUE)
}

(raster(paste0(dir_CHELSA,'tmean/',fName2Save))/10 - 273.15) %>% plot()
```

### Bias Correcting CHELSA v1.2.1 Precipitation Data for Snow Undercatch

```{r,eval=FALSE}
## general info - function arguments
basinName <- 'Gunt'
dataType_ERA5 <- 'tp'
#basinShape <- 'to be passed in'
targetCRS <- "+init=epsg:32642"
## Directories of relevant climate files  - function arguments
dir_CHELSA <- '/Users/tobiassiegfried/Dropbox (hydrosolutions)/1_HSOL_PROJECTS/PROJECTS/SDC/DKU_WRM_COURSE_CA/CourseMaterials/Data/CLIMATE/CHELSA_V1_2_1/'
# Basin AOI - function arguments, but check if all can be derived from the basinShape that is anyhow to be passed in!
aoi_Basin_LatLon <- gunt_Shapefile_LatLon %>% extent # GUNT
# ===
fileCorrFact <- '/Users/tobiassiegfried/Dropbox (hydrosolutions)/1_HSOL_PROJECTS/PROJECTS/SDC/DKU_WRM_COURSE_CA/CourseMaterials/Data/CLIMATE/PBCOR_V1/CHELSA_V12.nc'
# Get CHELSA file list - Note, we already have cut to the CA domain!
fileList <- list.files(paste0(dir_CHELSA,dataType_ERA5))
# beginning and end
startY <- 1981
endY <- 2013
# Monthly correction factors (Beck et al., 2020)
#pbcorr_monthly <- nc_open(dir_CorrFact)
pbcorr_monthly <- brick(fileCorrFact, varname="corr_fac_monthly")
pbcorr_monthly_basin_longlat <- raster::crop(pbcorr_monthly,aoi_CentralAsia_LatLon)
# start to loop through years and months for bias correcting the monthly values.
for (yr in startY:endY){
  for (mon in 1:12){
    # Load corresponding tmean CHELSA Central Asia File
    if (mon<10){
      chelsa_data_orig <- 
        raster(paste0(dir_CHELSA,dataType_ERA5,'/CHELSA_prec_',yr,'_0',mon,'_CA_V1.2.1.tif'))
      numbPrefix <- '_0'
    } else {
      chelsa_data_orig <- 
        raster(paste0(dir_CHELSA,dataType_ERA5,'/CHELSA_prec_',yr,'_',mon,'_CA_V1.2.1.tif'))
      numbPrefix <- '_'
    }
    chelsa_data_orig_resamp <- raster::resample(chelsa_data_orig,pbcorr_monthly_basin_longlat)
    chelsa_data_bcorr_resamp <- overlay(chelsa_data_orig_resamp,subset(pbcorr_monthly_basin_longlat,mon),
                                        fun=function(x,y){return(x*y)})
   # write bias corrected CHELSA back to the disk.
    raster::writeRaster(chelsa_data_bcorr_resamp,
                        paste0(dir_CHELSA,dataType_ERA5,'/CHELSA_tp_bcorr_',yr,numbPrefix,mon,'_CA_V1.2.1.tif'),
                        'GTiff',
                        varname   = dataType_ERA5,
                        overwrite = TRUE)
    #chelsa_data_bcorr_resamp %>% plot()
  }
}
```

### Computing Mean Monthly Temperature Climatology from CHELSA v1.2.1 data

The following code take CHELSA_V1.2.1 mean monthly temperature raster data and computes long-term mean monthly temperatures over the Central Asia domain. The resulting file can optionally be stored on the disk.

```{r, eval=FALSE}
fDir <- '../HydrologicalModeling_CentralAsia_Data/CentralAsiaDomain/CHELSA_V1.2.1/'
# First, we process and display mean monthly 2 meters temperatures.
varDir <- 't2m/'
t2m_files <- list.files(paste0(fDir,varDir))
# Get monthly fields and average over all data for resulting climatology
idxSeq <- seq(1,409,12)
for (idx in (1:12)){
  print(months[idx])
  t2m_files_sel <- t2m_files[idxSeq]
  for (idxRaster in (1:length(t2m_files_sel))){
    if (idxRaster == 1){
      raster_res <- raster::raster(paste0(fDir,varDir,'/',t2m_files_sel[1]))
    } else {
      raster_n <- raster::raster(paste0(fDir,varDir,'/',t2m_files_sel[idxRaster]))
      raster_res <- raster::addLayer(raster_n,raster_res)
    }
    raster_res_mean <- calc(raster_res, fun = mean)
  }
  if (idx ==1){
    raster_res_mean_stack <- raster_res_mean
  } else {
    raster_res_mean_stack <- raster::addLayer(raster_res_mean_stack,raster_res_mean)
  }
  idxSeq  <- idxSeq + 1
}

names(raster_res_mean_stack) <- month.abb

# raster::writeRaster(raster_res_mean_stack,
#                         paste0(fDir,'t2m_climatology/t2m_climatology_CA.tiff'),
#                         options="INTERLEAVE=BAND",
#                         'GTiff',
#                         varname   = 't2m',
#                         overwrite = TRUE)
```

### ERA5




## Appendix D: Solutions to exercises {#sectin-appendix-solutions}

### Exercise on Linear Reservoir modelling {#section-appendix-solutions-exercise1}
#### Task 1 {#solution-task1-experimental-setup}  

##### What will determine the flow through your bucket?  
The flow through the bucket will be influenced by the volume to bottom area fraction of the bucket, the amount and speed of water added to the bucket and the size of the outlet hole. 

##### What do you need to measure?   
You will need to measure:   

* the discharge from your bucket over time,  
* the recharge volume (how much water you put into the bucket over a given time),   
* the time when you start pouring water and when you stop pouring water into the bucket,  
* the approximate volume of your bucket.  

##### How can you measure it? 
This depends on what you have available. You can draw a water level line outside of your outflow receptacle every 10 seconds and then determine the volume change over time. Maybe you have a scale and a smart phone so you can put your outflow receptacle on the scale and make a movie of the weight change over time (1kg of water is approximately 1l of water).   
For the inflow pour a well defined volume over a well defined time interval. You can do this manually unless of course you have pipes and valves lying around that you can use.   
You will need a watch for measuring time and a receptacle with known volume to measure volumes (or a scale).    
A couple of notes on measurement accuracy:   

* Generally, the larger the volumes, the smaller the relative measurement error. Say you measure a discharge of 50ml in 1s (i.e. 50ml/s) and you can read your volume with an accuracy of 5ml and the time with an accuracy of 0.2s. Your measurement uncertainty becomes 11ml/s which is more than 20% of your discharge. If on the other hand, you measure 500ml over 10s (which is the same discharge of 50ml/s) with the same inaccuracies for volume and time your measurement uncertainty for discharge becomes 1ml/s which is only 2% of your discharge.  
* How do you estimate measurement uncertainties: Measure several times, compute the average and the standard deviation of your measurements assuming a student-t distribution.   
* How do you combine uncertainties of volume and time to the uncertainty of discharge: By applying Gaussian error propagation.   

##### What materials you will need to set up the experiment?
* For the bucket (the linear reservoir): A plastic bottle, a box or a can that is no longer used. It should have an opening at the top and the material should repel water and be thin enough that you can drill a hole into the wall.   
* A pair of pointy scissors or a knife to drill a hole into the bucket.   
* A water source (a tap, hose or a water container larger than the one above). This will be your rain machine.   
* A watch to measure time.  
* Note paper and pen.   
* A receptacle for measuring the outflow.   
* Additional material to facilitate measurement according to availability.   

```{r fig-solution1-example-setup, echo=FALSE, fig.show = "hold", out.width="90%", fig.align="center", fig.cap="Example for material needed and example setup to perform the linear reservoir experiment. Add a minion with a stop watch or a smart phone to help you logging the discharge from the bucket. "}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig_experimentalSetup.jpg")
```

##### Where will you get the water from and can you re-use it after the experiment? 
This depends on your situation.   

Back to the [recap section](#section-rsminerve-why-model-introduction)


#### Task 2 {#solution-task2-perform-experiment}
The video was recorded with a smart phone. The weight of the outflow receptacle was noted down every second. The discharge is computed as the change of volume in the outflow receptacle over time.    

<iframe width="720" height="480" src="_bookdown_files/FIG_Appendix_QuickGuides/bucket_video.mp4" align="middle" frameborder="0" allowfullscreen></iframe>

Back to the [recap section](#section-rsminerve-why-model-introduction)


#### Task 3 {#solution-task3-simulate}
The height of the measured discharge peak can be best reproduced with k = 0.42. However, the measured discharge peaks 1s later than the simulated discharge peak.   
Reasons for the discrepancy can be the shape of the linear reservoir, non-linear pouring speed, and measurement uncertainties.       

Back to the [recap section](#section-rsminerve-why-model-introduction)

#### Task 4 {#solution-task4-think}
ToDo       

Back to the [recap section](#section-rsminerve-why-model-introduction)



### Exercises on the HBV model {#section-appendix-solutions-hbv-exercises}

#### Exercise: Driving forces of the HBV model {#section-appendix-solutions-hbv-driving-forces}
The model drivers are precipitation, temperature and evaporation (P, T and ET in Figure \@ref(fig:fig-overview-hbv-model)). You need to provide time series of the model drivers to the model. Evaporation is typically not measured at climate stations but many empirical functions are available in the literature to estimate evaporation. RS Minerve offers the possibility to calculate evaporation based on temperature measurements and catchment location (you will do that later in this tutorial).  

Back to the [HBV model section](#section-hbv-model)

#### Exercise - HBV model states {#section-appendix-solutions-hbv-parameters-states}
The model states are the snow water equivalent height (SWE), the relative water content in the snow pack (WH), the humidity (Hum), the upper reservoir water level (SU) and the lower reservoir water level (SL). The model states are initialised using the initial conditions (see Figure \@ref(fig:fig-overview-hbv-model-parameters)).   

Back to the [HBV model section](#section-hbv-model)

#### Exercise: Data visualization in RS Minerve   {#section-appendix-solutions-plot-temperature-and-precipitation-1984}
Simulate from the 01/01/1981 01:00:00 to 31/12/1983 23:00:00, then choose data from 31/12/1983 23:00:00 as the initial conditions and run the model from 01/01/1984 01:00:00 to 31/12/1984 23:00:00. Choose hourly output for the simulation results.   
Open the Selection and plots tab by clicking on the Selection and plots button in the Modules toolbar and select simulated P and T from the Nauvalisoy station (Figure \@ref(fig:fig-pt-nauvailsoy)). 
```{r fig-pt-nauvailsoy, echo=FALSE, out.width="95%", fig.align="center", fig.cap="Hourly precipitation and temperature at the virtual Nauvalisoy weather station."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig116_plotPThourly.png")
```

Note: If you want to repeat a simulation with specific initial conditions, you can store them through Export IC in the Model Properties toolbar. 

The approximate temperature range is -13 in December to 34 deg C in August. The annual precipitation is about 1.4m (visualize Pcum and click on the last value of the time series). No precipitation falls during the summer months.  

Back to the  [Nauvalisoy model setup section](#section-hbv-nauvalisoy-modelling-setup). 


#### Exercise: Compare evaporation methods {#section-appendix-solutions-compare-evaporation-methods}
Figure \@ref(fig:fig-evaporation-discharge) shows the evaporation computed with various methods and the resulting discharge. Uniform evaporation should not be used for sub-annual modeling time steps. The difference between the methods by Turc, McGuinness and Oudin are within 5% of total discharge which is negligible for a regional model.   
```{r fig-evaporation-discharge, echo=FALSE, out.width="95%", fig.align="center", fig.cap="Hourly precipitation and temperature at the virtual Nauvalisoy weather station."}
knitr::include_graphics("_bookdown_files/FIG_Appendix_QuickGuides/fig119_evaporationDischarge1984.png")
```
For advanced modeling, the choice of the evaporation model may be relevant but only if a validation with measured data is possible.   
A uniform evaporation model is not suitable for simulation time steps smaller than 1 year as it disregards the seasonality of the evaporation. It may be suitable for average annual models but you have to enter a reasonable value for evaporation yourself. 

Back to the  [Nauvalisoy model setup section](#section-hbv-nauvalisoy-modelling-setup). 


#### Exercise: Common difficulties in model calibration {#section-appendix-solutions-common-calibration-issues}
1. Especially fully and semi-distributed hydrological models are typically over-parameterized, i.e. the number of model parameters is much larger than the number of observations for the model states. The true parameter values of the system cannot be uniquely identified based on a discharge time series alone.   
2. The outcome of the calibration depends on the measure of similarity between the simulated and the measured discharge. 
3. The water balance is often forgotten during model calibration. A nice fit of of the discharge curve can for example be achieved by increasing the volume of water in the model over time.   
4. The model is calibrated against historical data. Its ability to predict future discharge may be limited.  
5. The model is not perfect, it remains an approximation of the real system and may not incorporate all relevant processes of the hydrologic cycle (e.g. water storage and transport in glaciers for the case of the HBV model or significant sub-surface water fluxes that are unknown (for example in Karst regions)).  
6. Discharge measurements typically have uncertainties of 20%. Particularly measurements at the lower and upper ends of the rating curve (i.e. the water table - discharge relationship) are typically prone to larger uncertainties (bonus question: think about why this is so!). Is the measurement location or the equipment not properly maintained, biases may grow over time. On the other hand, if the measurement method is updated and changed, the measured discharge may display a different pattern (for an example, look at the low flow of the discharge of the river Gunt in Figure \@ref(fig:GuntMonthlyQ)).  

Back to the [calibration section](#section-calibration-principles)

#### Exercise: Strategies to overcome some of the model calibration difficulties {#section-appendix-solutions-strategies-for-issues}

1. Over-parameterization:   
  + Consider simplifying the model, i.e. reducing the number of parameters. If the model complexity is required, try adding additional measured variables (e.g. snow cover from MODIS data (see Chapter on [snow cover data](#section-data-snow-cover))) to validate individual components of the HBV model.    
  + Collect data to verify individual fluxes of the model components (e.g. soil parameters, snow water equivalent, etc.). As physical measurements in the field are not always possible you may have to become creative here, e.g. use MODIS snow cover data to validate the snow/no snow partitioning of the HBV model. Also consult the literature for parameterizations of similar catchments.   
2. Use a combination of similarity measures. This will be demonstrated later on in the model calibration section.   
3. During model calibration, look at the components of the model as well as the total discharge time series. Make sure that the storage of water changes within reasonable bounds and that the partitioning of the water in your system is physically reasonable (e.g. comparatively small storage compartments for rocky mountain catchments).    
3. Exclude part of your data set from model calibration and use it for model validation. If the model does not perform well in the validation period, its parameters are too specific for the calibration period and the model is said to not generalize well. If this happens you should try to reduce the number of parameters in your model. To understand better which parameters are responsible for the over-fit of the historical discharge, use different calibration and validation periods and compare the resulting parameters. Through sensitivity analysis, identify the model components that are most sensitive to predicted changes of model forcings, geometry or parameterization and perform scenario analysis.   
4. Implement and validate multiple possible conceptual models. All of the models must be calibrated and validated individually. It is further recommended to calculate at the highest possible temporal resolution and to try and compare the model outcome at different spatial resolution.       
5. Square-root filters or data assimilation algorithms are able to account for non-correlated measurement errors (they are not implemented in RS Minerve and not topic of this course). Error bands for the measurements should be adapted when communicating model results.  

Most of the above points will be discussed in more detail during this course.  

Back to the [calibration section](#section-calibration-principles)


#### Exercise: Calibrate a simple HBV model {#section-appendix-solutions-calibrated parameters}
The parameter set of the calibrated model are: 

```{r, echo=FALSE,message=FALSE,warning=FALSE,error=FALSE}
calibrated_parameters <- read.delim("./data/SyrDarya/Chirchiq/RSMinerve/nauvalisoy_PAR_calibrated.txt", 
                                    header = TRUE, skip = 9, nrows = 1) 
calibrated_parameters <- calibrated_parameters[,4:dim(calibrated_parameters)[2]]
colnames(calibrated_parameters) <- c("CFMax (mm/°C/d)", "CFR (-)", "CWH (-)", 
                                     "TT (°C)", "TTInt (°C)", "TTSM (°C)", 
                                     "Beta (-)", "FC (mm)", "PWP (-)", 
                                     "SUMax (mm)", "Kr (1/d)", "Ku (1/d)", 
                                     "Kl (1/d)", "Kperc (1/d)")
print(knitr::kable(t(calibrated_parameters)))
```

You can import the calibrated parameters via Import P in the Model Properties toolbar (the calibrated parameters are available in ./data/SyrDarya/Chirchiq/RSMinerve/nauvalisoy_PAR_calibrated.txt. 

Back to the [practical calibration section](#secion-calibration-practical-steps)









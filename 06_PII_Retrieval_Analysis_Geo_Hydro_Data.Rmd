# (PART) Part II Applied Modeling {-} 

# Retrieval & Analysis of Data

## Prerequisites {-}

This Chapter requires the following R packages to be installed. If you are running R in RStudio and some of the packages are not yet installed on your computer, RStudio will warn you and ask, whether you want to have them installed. Here I change something.

```{r codeLoad, echo=TRUE, eval = FALSE}
# Tidyverse 
library(tidyverse)

# File navigation
library(here)

# Copernicus Climate Data Store
library(ecmwfr)
library(keyring)

# Handling netcdf files
library(ncdf4)

# Spatial data plotting & plotting
library(rgdal)
library(raster)
library(rgeos)
library(sp)
library(sf)
library(rasterVis)
library(RColorBrewer)
```

## Geospatial Data



## Climate Data

### Access, Select and Download ERA5 Reanalysis Data

For the climate data to be used in the modeling approach, we use ERA5 data from the European Center for Medium-Range Weather Forecasts (ECMWF, <www.ecmwf.int>). ERA5, the successor to ERA-Interim,  provides global, hourly estimates of atmospheric variables, at a horizontal resolution of 31 km and 137 vertical levels from the surface to 0.01 hPa [@era5-desc]. ERA5 presently extends back to 1979 but will ultimately be extended back to 1950^[Although this is an extraordinary product, users still need to be aware of the limitations of reanalysis; two of the major ones are that non-physical trends and variability may be present in the record due to changes in the observing system, and that the climatologies of some variables, like surface energy fluxes, are not well represented.]. 

The ERA5 data is available via the Copernicus Climate Store at <https://cds.climate.copernicus.eu>. However, before we can access, select and download it there, each user has to register with a personal account in the store. For this purpose, the user should navigate to the website and register via the Login/Register/NewAccount Menu. You will receive an email once your account is ready.

Log in to your account and go to your user profile where you find your user ID and API key. The relevant information should be copied and into the relevant places of the code chunk below and then be executed. 

```{r,eval=FALSE}
#Note: replace the UID and key strings below with the proper user's information in your Copernicus Climate Data Store account.
UID <- 'UID'
API_key <- 'key'
#This function links your password and user id for later steps
wf_set_key(UID, API_key, 'cds')
```

//TODO: output still showing. How to deal with it?
```{r ecmf_real_register, echo = FALSE, message = FALSE}
#Note: replace these strings with the information in your Copernicus Climate Data Store account
UID <- '11732'
API_key <- '9b6f4531-b1f0-4005-82e5-afa48aabd3e2'
#This function links your password and user id for later steps
wf_set_key(UID, API_key, 'cds')
```

If all worked well, you will get the following confirmation in the console:
```{r <chunk-label>, echo = TRUE,eval=FALSE}
## User UID for cds service added successfully
```

On the Copernicus website, make sure that you are logged into your account and the navigate to Datasets. There, search for the Product 'ERA5-Land monthly averaged data from 1981 to present' and select it^[The direct link is <https://cds.climate.copernicus.eu/cdsapp#!/dataset/reanalysis-era5-land-monthly-means?tab=form>.]. You end up on the products homepage where you can get more information and download the data via a form where you select the product's type, variables, the years, months and time of day, the geographical area and, finally, the download file format of interest. Please select the following:

- Product type: Monthly averaged reanalysis
- Variable:
    - Temperature: 2 m Temperature
    - Lakes: NA
    - Snow: NA
    - Soil Water: NA
    - Radiation and Heat: NA
    - Evaporation and Runoff: Potential evaporation
    - Wind, Pressure and Precipitation: Total precipitation
    - Vegetation: NA
- Year: Select all
- Month: Select all
- Time: 00:00
- Geographical area: Sub-region extraction  (West = 65, East = 80, South = 35, North = 45)
- Format: NetCDF (experimental)

Accept the Terms of use and press the 'Show API request button'. You should see the following Python request now as shown in Figure \@ref(fig:Copernicus-API-Request).

```{r Copernicus-API-Request, echo = FALSE, fig.cap = 'Screenshot showing the Copernicus Data Store API request that can be copied and posted into RStudio for the convenient download of the data there.'}
knitr::include_graphics('_bookdown_files/Chap4-Figures/fig_Copernicus_API_request')
```

The request should be copied and pasted into RStudio into your current .Rmd file there. Select the python request with the cursor and choose 'ECMWFR/Python to List' under the Addins Menu. The python request will then automatically be translated into a an r command. Please check that everything is ok by comparing it with a correct request as shown below. Also, please note that we have changed the target file name by specifying `target = reanalysis-era5-land-monthly-means_CentralAsia.nc`.

In a final step, the user can then download the data with the `wf_request()` function. 


```{r ERA5-request, echo = TRUE, eval = FALSE}
# Here is is the resulting request in R language 
request <- list("dataset_short_name" = "reanalysis-era5-land-monthly-means",
  format = "netcdf",
  product_type = "monthly_averaged_reanalysis",
  variable = c('2m_temperature', 'potential_evaporation', 'total_precipitation'),
  year =  c('1981', '1982', '1983',
            '1984', '1985', '1986',
            '1987', '1988', '1989',
            '1990', '1991', '1992',
            '1993', '1994', '1995',
            '1996', '1997', '1998',
            '1999', '2000', '2001',
            '2002', '2003', '2004',
            '2005', '2006', '2007',
            '2008', '2009', '2010',
            '2011', '2012', '2013',
            '2014', '2015', '2016',
            '2017', '2018', '2019',
            '2020'),
  month = c("01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"),
  time = "00:00",
  area = "45/65/35/80",
  #dataset = "reanalysis-era5-land-monthly-means",
  target = "reanalysis-era5-land-monthly-means_CentralAsia.nc"
)

# Download data as netcdf file and store it in the directory where you are running this script, this returns the path to the file 
ncfilelink <- wf_request(user = UID,
                     request = request,
                     transfer = TRUE,
                     path = here(),
                     verbose = TRUE)
```

```{r, echo = FALSE, eval = TRUE, results = 'hide', warning = FALSE, message = FALSE}
# Here is is the resulting request in R language 
request <- list("dataset_short_name" = "reanalysis-era5-land-monthly-means",
  format = "netcdf",
  product_type = "monthly_averaged_reanalysis",
  variable = c('2m_temperature', 'potential_evaporation', 'total_precipitation'),
  year =  c('1981', '1982', '1983',
            '1984', '1985', '1986',
            '1987', '1988', '1989',
            '1990', '1991', '1992',
            '1993', '1994', '1995',
            '1996', '1997', '1998',
            '1999', '2000', '2001',
            '2002', '2003', '2004',
            '2005', '2006', '2007',
            '2008', '2009', '2010',
            '2011', '2012', '2013',
            '2014', '2015', '2016',
            '2017', '2018', '2019',
            '2020'),
  month = c("01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"),
  time = "00:00",
  area = "45/65/35/80",
  #dataset = "reanalysis-era5-land-monthly-means",
  target = "reanalysis-era5-land-monthly-means_CentralAsia.nc"
)

# Download data as netcdf file and store it in the directory where you are running this script, this returns the path to the file 
ncfilelink <- wf_request(user = UID,
                     request = request,
                     transfer = TRUE,
                     path = here(),
                     verbose = TRUE)
```

```{r , eval = TRUE, echo=FALSE, results = 'show'}
print('moved temporary file to -> /.../reanalysis-era5-land-monthly-means_CentralAsia.nc')
print('request purged from queue!')
```

 
Some Sources on NetCDF and raster files:
Here are some good resources to get you started: <https://pjbartlein.github.io/REarthSysSci/index.html> and
<https://cmerow.github.io/RDataScience/05_Raster.html>. 






## Hydrological Data

//TODO: Show added value from consulting data from altimetry <https://dahiti.dgfi.tum.de/en/map/>



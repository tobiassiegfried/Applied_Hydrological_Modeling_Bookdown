# Hydrological Modeling: Empirical Models {#HydroModelsEmpiricalModels}

## Background on Empirical Modeling

## Key Forecasting Techniques

-   feature engineering

-   experimentation and ensembling

-   Knowledge of key events, i.e. date shifts holidays

-   Deep learning (data permitting)

-   Boosting errors

## Getting Started

### Loading the Required Packages and Data

In a first step, we load all packages that are required in this Chapter to perform the analysis. Note that RStudio informs you if you have some of the packages not yet installed. If that is the case, you should click choose to install the suggested package by clicking `Install`.

```{r,message=FALSE}
# * Course data ----
devtools::install_github("hydrosolutions/riversCentralAsia")
library(riversCentralAsia)

# * Forecasting Libraries ----
library(forecast)     # Auto ARIMA, ETS
library(rstan)
library(prophet)      # FB Prophet

# * Machine Learning Libraries ----
library(glmnet)       # Elastic Net
library(earth)        # Mars Regression Splines
library(kernlab)      # Support Vector Machine
library(kknn)         # K-Nearest Neighbors
library(randomForest) # Random Forest
library(ranger)       # Random Forest
library(xgboost)      # Boosted Trees
library(Cubist)       # Cubist Rule-Based Algorithm

# * Deep Learning Libraries ----
library(reticulate)   # Python interface

# * Time Series ML ----
library(tidymodels)   # Meta - workflows, parsnip, tune, dials, recipes, rsample, yardstick
library(rules)        # Rule-based models (cubist)
library(modeltime)    # tidymodels time series extension
library(modeltime.ensemble) # this is for ensemble modeling

# * Core Libraries ----
library(tidyverse)    # Meta - dplyr, ggplot2, purrr, tidyr, stringr, forcats
library(lubridate)    # date and time
library(timetk)       # Time series data wrangling, visualization and preprocessing

# Extras
library(DataExplorer)
library(fs)

# Kntting tables
library(knitr)
```

The `riversCentralAsia` Package makes selected data of the Chirchik River Basin available. These include discharge and meteorological data from the basin. Once this package is loaded, we are ready to start with data analysis.

```{r}
ChirchikRiverBasin # load data
?ChirchikRiverBasin
data <- ChirchikRiverBasin
```

To get more information about the data, simply call the package data help documentation.

```{r}
?ChirchikRiverBasin
```

## Exploratory Data Analysis & Data Preparation

### Discharge Data

There are 6 discharge stations where `type = Q`. These are all unique stations as can be identified by their stations codes (see above in Figure \@ref(fig:ChirchikRiverOverview) for the station locations.

We can generate timeseries plots of the river discharge data only by setting the corresponding station filter via `filter(type=='Q')`.

```{r,warning=FALSE}
data %>% filter(type=='Q') %>% group_by(type,code,station,resolution) %>% plot_time_series(date,data,.facet_ncol = 2,.interactive = FALSE, .smooth = FALSE, .title = 'Available discharge data of Chirchik River Basin')
```

The characteristics of the timeseries feature the typical snowmelt-driven runoff pattern with pronounced seasonality and internannual variability. At Chinaz near the confluence of the Chirchik River with the Syr Darya, however, a changing discharge regime can easily be identified over time. The drastic decrease in discharge in the 1960ies is due to the extension of upstream irrigation and increases in interbasin water transfers. This timeseries is non-stationary for this reason and unless we not also understand the changing allocation patterns between Charvak reservoir and Chinaz gauge, it will not be possible to forecast the flow there.

Getting summary statistics of the gauged discharges allows us to quickly understand runoff contributions of the individual tributaries.

```{r}
data %>% filter(type == 'Q') %>% 
  dplyr::select(date,data,code) %>% group_by(code) %>% 
  summarise(mean = mean(data,na.rm=TRUE), 
            min = min(data,na.rm=TRUE), 
            max = max(data,na.rm=TRUE), 
            sd = sd(data,na.rm=TRUE))
```

The timeseries for the two main tributaries, i.e. the Pskem River (Gauge 16290) and the Chatkal River (Gauge 16279) are almost complete decadal records from 1933 until and including 2015.

We can easily get summary statistics of one discharge station by first filtering and then summarizing. The example below shows the code for Gauge 16279 at Khudaydod located in the Chatkal River Basin.

```{r}
data %>% filter(type=='Q', code=='16279') %>% summary()

```




=====

All discharge timeseries except the one at Chinaz look regular in the sense that they are not influenced by human activity. In all cases, significant interannual variability is visible. At Chinaz, however, it can be clearly seen that the discharge regime is changing from the 1960ies onward because of the increase of irrigation and interbasin water transfer between Charvak Reservoir and the confluence with the Syr Darya.

Let us focus for the time being for the hydrological situation above Charvak dam. The reservoir receives data from different tributaries, including from Nauvalisoy, Pskem, Koksu and Chatkal rivers. All of them are gauged except Koksu River, i.e. the small catchment between Pskem and Chatkal rivers. Its contribution to runoff is estimated using an empirical relationship that was established prior to the closure of the dam. At that time, Charvak gauge was still in operation where total discharge of the Chatkal River was measured, including the one from Koksu. Hence,

$$
Q_{Koksu} \propto Q_{Charvak Gauge} - Q_{16279} 
$$

The relationship was estimated using daily data over three years.

is estimated through previously established empirical relationships between Chatkal dicharge

For the time being, we want to focus on the zone of runoff formation and on the two main tributaries of the Chirchik River, i.e. the Chatkal and Pskem Rivers. Let us plot the two timeseries, including also the discharge data at the Charvak Reservoir at Gauge 16294.

After the completion of the Charvak Reservoir dam in 1970, the original gauge got flooded and its discharge is since computed using correlations with

including also their seasonal diagnostics in the following way.

```{r,warning=FALSE}
data %>% filter(type=='Q',code!=16298,code!=16275,code!=16300,code!=16294) %>% group_by(type,code,station,resolution) %>% plot_time_series(date,data,.facet_ncol = 1,.interactive = FALSE, .smooth = FALSE, .title = 'Main Tributaries of Chirchik River Basin')
```

As is easily visible, we have a near complete record of 84 years of decadal data available for these two stations starting from 1932 until and including 2015.

```{r,warning=FALSE}
data %>% filter(type=='Q',code!=16298,code!=16275,code!=16300,code!=16294) %>% group_by(type,code,station,resolution) %>% plot_seasonal_diagnostics(date,data,.interactive = FALSE,.feature_set = c("week","month.lbl","year"))
```

The summer peak discharge in the Chatkal River is, on average, 3 weeks earlier in the summer season because of the different altitude zonation and characteristics of the two catchments (see also Chapter \@ref(HydrologicalSystems) for more details).

### Meteorological Data

